<!DOCTYPE html>
<html>
<head>
    <title>Subliminal</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../styles.css">
    <script type="text/javascript">
        let poemTags = []

        //Make user confirm that they want to leave the page.
        window.onbeforeunload = function() {
            if (confirm("Save before exiting?")) save()
            return true
        }

        //Load saved poems from local storage
        window.onload = function() {
            fetchStorage();
        }

        function fetchStorage() {
            document.getElementById("loadDiv").innerHTML = "Load: <br>";
            for (let i = 0; i < localStorage.length; i++) {
                let current = localStorage.getItem(localStorage.key(i));
                document.getElementById("loadDiv").innerHTML += `<input class="tool" onclick="load('${localStorage.key(i)}')" type="button" value="${localStorage.key(i)}"> <br>`;
            }
        }

        function save() {
            let title = document.getElementById("title");
            let content = document.getElementById("content");
            let saveData = {
                summary: summaryArea.value, //meta description
                tags: poemTags.toString(), //meta keywords
                title: title.innerHTML.split("- By")[0].trim(), //meta title
                cWarning: cWarningCheckbox.checked, //content warning
                cWarningAdditions: cWarningNotesInput.value, //content warning additional notes
                fullTitle: title.innerHTML, //poem header title
                poemContent: content.innerHTML, //poem html
                pageStyle: document.getElementById("main").className, //poem visual format
                pageBackground: document.body.style.background //poem background image
            }
            localStorage.setItem(title.innerText.split("- By")[0].trim().toLowerCase().replaceAll(" ", "-"), JSON.stringify(saveData));
            
            //Refresh load box with latest poem. 
            fetchStorage();
        }

        function load(key) {
            let loadObject = JSON.parse(localStorage.getItem(key));
            summaryArea.value = loadObject.summary;
            poemTags = []
            for(let t of loadObject.tags.split(",")) { 
                addPoemTag(t)
            }
            cWarningCheckbox.checked = loadObject.cWarning
            cWarningNotesInput.disabled = loadObject.cWarning ? false : true
            cWarningNotesInput.value = loadObject.cWarningAdditions
            title.innerHTML = loadObject.fullTitle;
            content.innerHTML = loadObject.poemContent;
            document.body.style.background = loadObject.pageBackground;
            document.getElementById("main").className = loadObject.pageStyle;
        }

        //This itelf is just the poem-editor, content will be moved from here to a new template file, and then downloaded
        async function download() {
            save()
            let loadObject = JSON.parse(localStorage.getItem(title.innerText.split("- By")[0].trim().toLowerCase().replaceAll(" ", "-")));
            let poemTemplate = await (await fetch("poem-template.html")).text()
            let cWTemplate = await (await fetch("content-warning-template.html")).text()

            let finishedCWTemplate
            if (loadObject.cWarning === true) {
                let nts = loadObject.cWarningAdditions;
                nts = "|".concat(nts)
                for (let i = 0; i < nts.length; i++) {
                    if (i % 30 != 0) return
                    nts = nts.substring(0, i) + "|\n" + nts.substring(i, nts.length)
                }
                finishedCWTemplate = cWTemplate
                .replace("ADDITIONAL_NOTES", nts)
            }

            let finishedPoemTemplate = poemTemplate
                .replace("NAME", loadObject.title)
                .replace("SUMMARY", loadObject.summary)
                .replace("TAGS", loadObject.tags)
                .replace("POEM_BACKGROUND", loadObject.pageBackground)
                .replace("TITLE", loadObject.fullTitle)
                .replace("POEM_STYLE", loadObject.pageStyle)
                .replace("CONTENT", loadObject.poemContent)
                .replace("CONTENT_WARNING", finishedCWTemplate ? finishedCWTemplate : "")
                .replace("DATE", Date.now())

            let element = document.createElement('a')
            element.setAttribute('href', 'data:text/html;charset=UTF-8,' + encodeURIComponent(finishedPoemTemplate));
            element.setAttribute('download', title.innerText.split("- By")[0].trim().toLowerCase().replaceAll(" ", "-") + "");
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            confirm("Page sucessfully created!\nDownload and create a pull request on github, in order to have your new poem merged into the main site.");
        }

        function format(command, value) {
            document.execCommand(command, false, value);
            document.getElementById("content").focus();
        }

        function formatCustom(tag) {
            selectionText = window.getSelection(); //TODO: Make this toggle-able, like the rest.
            document.execCommand("insertHTML", false, "<"+tag+">" + selectionText + "</"+tag+">");
            document.getElementById("content").focus();
        }

        function formatImage() {
            console.log(window.opener.document.getElementById("content").selectionStart);
        }

        function changePageStyle(newStyle) {
            document.getElementById("main").className = newStyle;
        }

        //PATCH: To get chrome support for proper <br> based formatting, instead of divs for each line.
        function checkReturn(event) {
            if (event.key === 'Enter') {
                document.execCommand("insertLineBreak");
                event.preventDefault();
            }
        }
        //PATCH: Stop pasting weird formatted text that could break things.
        function checkPaste(event) {
            event.preventDefault();
            const text = event.clipboardData.getData('text/plain');
            text.replace("\n", "<br>")
            document.execCommand("insertHTML", false, text);
        }

        function handleBackgroundDrop(event) {            
            const reader = new FileReader();
            reader.readAsDataURL(event.files[0]);
            reader.onloadend = () => {
                document.body.style.background = `url('${reader.result}')`;
            }
        }

        function addPoemTag(tagName) {
            poemTags.push(tagName)
            let newTag = document.createElement("button")
            newTag.innerText = tagName
            tagContainer.appendChild(newTag)
        }
    </script>
    <style>
        .tool {
            margin: 1px;
            height: 24px;
            max-width: 100%;
        }
        .text-tools {
            position: fixed;
            top: 115px;
            left: 16px;
            border: 1px solid black;
            width: 160px;
            padding: 5px;
            border-radius: 2px;
            background-color: rgba(255, 255, 255, .2);
            backdrop-filter: blur(5px);
            box-shadow: 0px 2px 4px gray;
            z-index: 1;
        }
        .document-tools {
            position: fixed;
            top: 115px;
            right: 16px;
            border: 1px solid black;
            width: 180px;
            padding: 5px;
            border-radius: 2px;
            background-color: rgba(255, 255, 255, .2);
            backdrop-filter: blur(5px);
            box-shadow: 0px 2px 4px gray;
            z-index: 1;
        }

        #poem-tags > button {
            border-radius: 40px;
            height: 24;
        }

        @media screen and (orientation:portrait) {
            .text-tools { position: inherit !important; width: calc(100% - 12px); } 
            .document-tools { position: inherit !important; width: calc(100% - 12px); }
        }
    </style>
</head>
 <!--TODO: Ability to import webpages and edit them.-->
<body>
    <div class="title-blur" style="z-index: 2;">
        <h2 class="centre" id="title" contenteditable="true" onpaste="checkPaste()" onkeydown="if(event.key === 'Enter') { event.preventDefault(); return false; }" >Click On Me to Start Editing - By Click On Me to Start Editing</h2>
        <hr>
    </div>
    <div style="position: fixed; top: 90px;">
    </div>
    <div class="text-tools">
        Tools: <br>
        <input class="tool" onclick="format('bold', null)" type="button" value="Bold">
        <input class="tool" onclick="format('italic', null)" type="button" value="Italic">
        <input class="tool" onclick="formatCustom('code')" type="button" value="Code" disabled> <br>
        <input class="tool" onclick="format('superscript', null)" type="button" value="Superscript">
        <input class="tool" onclick="format('subscript', null)" type="button" value="Subscript"> <br>
        <input class="tool" onchange="format('foreColor', this.value);" value="#000000" style="height: 32px;" type="color"> <br>
        <input class="tool" onclick="formatImage()" type="button" value="Image" disabled> <br>
        <input class="tool" onclick="format('undo', null)" type="button" value="↩ undo">
        <input class="tool" onclick="format('redo', null)" type="button" value="redo ↪"> <br>
        <select class="tool" onchange="changePageStyle(value)" style="margin-top: 5px;">
            <option value="poem-centre" selected>Poem Centre</option>
            <option value="poem-centre-wide">Poem Centre Wide</option>
            <option value="centre">Centre</option>
        </select> <br>
        Background image: <br>
        <input type="file" multiple accept="image/*" onchange="handleBackgroundDrop(this)" style="width: 100%;">
        Poem summary: <br>
        <textarea id="summaryArea" type="text" style="min-width: calc(100% - 5px); min-height: 50px; width: calc(100% - 5px); height: 50px;"></textarea>
        Poem tags: <br>
        <div id="tagContainer"></div>
        <input type="text" placeholder="Add new tag" style="width: calc(100% - 5px); height: 24px;" onkeypress="if (event.key == 'Enter') { addPoemTag(this.value); this.value = ''; }">
        Content Warning: <br>
        <input type="checkbox" id="cWarningCheckbox" onclick="cWarningNotesInput.disabled = this.checked ? false : true"/>
        <label for="cWarningCheckbox"> Enabled</label><br>
        <input type="text" id="cWarningNotesInput" placeholder="Additional warning notes" style="width: calc(100% - 5px); height: 24px;" disabled>
    </div>
    <div id="toolbox" class="document-tools">
        Document Management: <br>
        <input class="tool" onclick="save()" type="button" value="Save draft poem 💾">
        <div style="margin: 2px; border: 1px solid black; padding: 5px;" id="loadDiv">
            Load: <br>
        </div>
        <button id="download-button" onclick="download()" style="position: relative; height: 32px;">Download edited page<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="2" xmlns:v="https://vecta.io/nano" width="18px" style="transform: translateY(8px);"><path d="M36.5 17v32.761m-8.695-8.116L36.5 50.31l8.695-8.665M27.5 55h18"></path></svg></button>        
    </div>
    <div id="main" class="poem-centre">
        <p id="content" contenteditable="true" onkeydown="checkReturn(event)" onpaste="checkPaste(event)">
            Click On Me to Start Editing
        </p>
    </div>
    <a href="../contents" class="back"> <- Back</a>
</body>
</html>
