<!DOCTYPE html>
<html>
<head>
    <title>Subliminal</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="./styles.css">
    <script type="text/javascript" src="./account.js"></script>
    <style>
        .tool {
            margin: 1px;
            height: 24px;
            max-width: 100%;
        }
        .text-tools {
            position: fixed;
            top: 146px;
            left: 16px;
            width: 160px;
            padding: 8px;
            border-radius: 8px;
            background-color: var(--button-transparent); /*var(--background-transparent);*/
            backdrop-filter: blur(5px);
            z-index: 1;
            transition: height .5s;
        }
        .tools-collapsed {
            text-align: right;
            position: absolute;
            right: 16px;
            rotate: 180deg;
            transform: translateY(4px);
        }
        .tools-collapsed > svg {
            fill: var(--text-colour);
        }
        .text-tools[collapsed="true"] {
            height: 36px;
            overflow: hidden;
        }
        .text-tools[collapsed="true"] .tools-collapsed {
            rotate: 0deg;
        }

        .document-tools {
            position: fixed;
            top: 130px;
            right: 0px;
            width: max(16%, 250px);
            padding: 8px;
            background-color: var(--button-transparent);
            backdrop-filter: blur(5px);
            box-shadow: 0px 0px 8px grey;
            z-index: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            row-gap: 8px;
            overflow-y: scroll;
        }

        #formattingToolbar {
            display: flex;
            padding-left: 8px;
            padding-right: 8px;
            padding-top: 1px;
            padding-bottom: 1px;
            column-gap: 8px;
            max-width: 100%;
            overflow-x: visible;
        }
        #formattingToolbar > div {
            height: 32px;
            width: 32px;
            min-width: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 4px;
            user-select: none;
            padding: 1px;
        }
        #formattingToolbar > div > div {
            background-color: var(--button-transparent);
            border-radius: 4px;
            pointer-events: none;
        }
        .separator {
            background: transparent;
            width: 1px !important;
            min-width: 1px !important;
            border-radius: 0px !important;
            opacity: 0.1;
            margin-left: 8px;
            margin-right: 8px;
            flex-grow: 1;
        }

        #poem-tags button {
            border-radius: 4px;
            margin: 2px;
        }

        #signCanvas {
            background: var(--button-opaque);
            width:50%;
            height:50%;
            border-radius:4px
        }
        .sign-container {
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-content:center;
            row-gap:4px;
            align-items:center;
            user-select:none;
        }
        .sign-buttons {
            display:flex;
            column-gap:8px;
            width:50%;
        }
        .sign-buttons > div {
            flex-grow: 1;
        }

        .management-button {
            position: relative;
            height: 32px;
            width: 100%;
            margin-top: 8px;
        }

        .button-tooltip {
            left: calc(-100% - 32px) !important;
        }

        #originalContent {
            position: absolute;
            z-index: -1;
            opacity: 0.2;
            user-select: none;
            margin: 0px;
        }
        /* patches for if the poem is in centre style */
        .centre > #originalContent {
            width: 100%;
            margin-top: -18px;
        }

        .tool-header {
            background-color: var(--button-opaque);
            width: calc(100% - 16px);
            display: block;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        #loadedContainer {
            display: flex;
            flex-direction: column;
            row-gap: 5px;
            max-height: 512px;
            overflow: scroll;
            height: 512px;
        }

        #summaryArea {
            min-height: 50px;
            width: calc(100% - 16px);
            height: 254px;
            resize: none;
            background: var(--button-opaque);
            border: none;
            outline: none;
            border-radius: 8px;
            font-family: Arial, Helvetica, sans-serif;
            padding: 8px;
            transition: .2s box-shadow;
        }

        #tagContainer, #cWarningContainer, #summaryArea {
            transition: .2s box-shadow;
        }

        #summaryArea:hover, #tagContainer:hover, #cWarningContainer:hover {
            box-shadow: 0px 0px 8px darkgray;
        }

        #builtinFreePopup img {
            border-radius: 4px;
            max-width: 100%;
        }

        .background-grid {
            display: grid;
            grid-template-columns: auto auto auto;
            grid-gap: 4px;
        }

        .background-grid > div {
            position: relative;
            overflow: hidden;
        }

        .background-grid > div:hover > div {
            top: 50%;
        }

        .background-grid > div > div {
            position: absolute;
            top: 100%;
            width: 100%;
            height: 50%;
            overflow: hidden;
            transition: .2s top;
            background-color: var(--button-opaque);
            user-select: none;
        }

        @media screen and (orientation:portrait) {
            .text-tools {
                position: inherit !important;
                width: calc(100% - 12px);
            }

            .document-tools {
                width: calc(100% - 12px);
                height: 60%;
                bottom: 0px;
                top: inherit;
                padding-top: 0px;
            }

            #signCanvas {
                width: 100%;
            }

            .sign-buttons {
                width: 100%;
            }

            #formattingToolbar {
                overflow-x: scroll;
            }

            #loadedContainer {
                height: calc(100% - 96px);
                max-height: calc(100% - 96px);
            }

            .separator {
                background: var(--text-colour);
            }

            .background-grid {
                grid-template-columns: auto auto;
            }
        }
    </style>
</head>
<body style="max-width: 100%; overflow-x: hidden; overflow-y: scroll;">
    <div id="licenseAgreePopup" class="popup" style="display: none;">
        <h2>License agreement:</h2>
        <p>All content on this site must be licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0, in order to make open source contribution easy, with the underlying source code used to format and display that content licensed under the GNU GPL-3 license. Summaries of these licenses are available at CC BY-NC-SA and GPL-3.</p>
        <p>By uploading your work to this site, you give consent for your poem to be licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0.</p>
        <p>You also agree to allow us permission to store and process your work. We can also accept no responsibility, if you write something that gets you in trouble with people you know, an institution, or local government, you agree that you WILLINGLY chose to upload it here. We accept no responsibility how your work is interpreted, and what consequences may or may not come as a result of it.</p>
        <p>You will always be the lone copyright owner of your work, we will never, ever take ownership of what you made from you, and we will always comply if you ask for your poem to be modified, and or taken down from this site.</p>
        <p>If you want to, you can <strong>sign</strong> your poem off below.</p>
        <div class="sign-container">
           <canvas height="96" width="256" id="signCanvas" onmousedown="signCanvasDown(event)" onmousemove="signCanvasDrag(event)" onmouseup="signCanvasUp(event)" ontouchstart="signCanvasDown(event)" ontouchmove="signCanvasDrag(event)" ontouchend="signCanvasUp(event)"></canvas>
            <div class="sign-buttons">
                <div class="popup-button" style="pointer-events: none; opacity: 0.2;">Smooth</div>
                <div class="popup-button" onclick="ctx.clearRect(0, 0, signCanvas.width, signCanvas.height);">Clear</div>
                <div class="popup-button" onclick="licenseAgreePopup.style.display = 'none'; ctx.clearRect(0, 0, signCanvas.width, signCanvas.height); uploadCurrent();">Submit</div>
            </div>
        </div>
        <p style="opacity:0.6;"><em>Please don't use a real signature you use on legal documents here. By pressing submit, you agree to all the terms stated above.</em></p>
    </div>

    <div id="builtinFreePopup" class="popup" style="display: none;">
        <h2>Built-in backgrounds:</h2>
        <p>These backgrounds are free for you to use to jazz up your poem's look! Drawn and shot by members of the subliminal team.</p>
        <div class="background-grid">
            <div><img loading="lazy" src="./Resources/Backgrounds/ChilternsWalk.jpg"><div>Taken somewhere in the Chilterns, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/FinlandIntersection.jpg"><div>Taken at an intersection somewhere between Uusikaupunki and Helsinki, Finland.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/IsoBoy.jpg"><div>A fish that mysteriously disappeared the next day, Island near Uusikaupunki, Finland.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/LondonCity.jpg"><div>A bridge to the Tate, London, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/LondonStreets.jpg"><div>A day in the city, near Farringdon, London, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/Portheleven.jpg"><div>It took standing on a rock in the middle of the sea to get this, Portheleven, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/FalmouthShellCave.jpg"><div>A really old shell cave, in Gyllyngdune Gardens, Falmouth, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/SnowdoniaPath.jpg"><div>A long path to mount Snowdon (maybe), Wales, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/SnowdoniaQuarry.jpg"><div>A spooky snap of quarry taken from a moving vehicle, Snowdonia, Wales, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/SnowdoniaQuarry2.jpg"><div>A sunnier view of the massive quarry, Snowdonia, Wales, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/SnowdoniaQuarry3.jpg"><div>An atmospheric pee(a)k (punny) of a quarry, Snowdonia, Wales, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/UusikaupunkiHorsepower.jpg"><div>This boat certainly has more than 5 horsepower, Island near Uusikaupunki, Finland.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/YorkshireMoorRoad.jpg"><div>A long, long road, past field and moor, Yorkshire, UK.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/ChaosDrawing.png"><div>Chaos, for those who want to have a bit of zazz around their stuff.</div></div>
            <div><img loading="lazy" src="./Resources/Backgrounds/AbbstraktBird.png"><div>Is it a bird? Dog? A secret message of text? All we know is that this mascot is iconic.</div></div>
        </div>
    </div>

    <div id="loadPoemPopup" class="popup" style="display: none/*block;*/">
        <h2>Load poem:</h2>
        <div id="loadedContainer"></div>
        <div class="popup-button" style="margin-top: 8px;" onclick="loadPoemPopup.style.display =  'none';">Done</div>
    </div>

    <div class="title-blur" style="z-index: 2;">
        <div style="display: flex;">
            <h2 id="poemName" onpaste="checkPaste(event)" onkeydown="if(event.key === 'Enter') { event.preventDefault(); return false; }" style="display: inline;flex-grow: 1;text-align: right;" contenteditable="true">Click On Me to Start Editing</h2>
            <h2 class="centre" style="display: inline;">&nbsp;- By&nbsp;</h2>
            <h2 id="poemAuthor" onpaste="checkPaste(event)" onkeydown="if(event.key === 'Enter') { event.preventDefault(); return false; }" style="display: inline;flex-grow: 1;text-align: left;" contenteditable="true">Click On Me to Start Editing</h2>
        </div>
        <hr>
        <div id="formattingToolbar">
            <div class="options-parent" style="width: 72px; min-width: 72px;" onclick="this.children[1].style.display = this.children[1].style.display == 'block' ? 'none' : 'block'" onblur="this.children[1].style.display = 'none'">
                <div>File ⯆</div>
                <div class="options" style="width: 120px;">
                    <div onclick="">Download poem</div>
                    <div onclick="">Save poem</div>
                    <div onclick="">See my drafts</div>
                    <div onclick="">Upload to site</div>
                </div>                
            </div>    
            <div onclick="format('undo', null)" style="width: 72px; min-width: 72px;"><div>↩ undo</div></div>
            <div onclick="format('redo', null)" style="width: 72px; min-width: 72px;"><div>redo ↪</div></div>
            <div onclick="format('bold', null)"><div style="font-weight: bold;">B</div></div>
            <div onclick="format('italic', null)"><div style="font-style: italic;">I</div></div>
            <div onclick="formatCustom('code')"><div style="font-family: monospace;">C</div></div>
            <div onclick="format('superscript', null)"><div>Sup</div></div>
            <div onclick="format('subscript', null)"><div>Sub</div></div>
            <div style="position: relative;">
                <input class="tool" onchange="format('foreColor', this.value); formattingColourRect.style.background = this.value" value="#000000" style="opacity: 0;position: absolute; left: 0px;top: 0px;width: 100%;height: 100%;" type="color">
                <div id="formattingColourRect" style="background-color: black; width: calc(100% - 2px); height: calc(100% - 2px); margin: 1px;border-radius: 4px;"></div>
            </div>
            <div><div>🖼️</div></div>
            <div class="separator"></div>
            <div class="options-parent" style="width: 112px; min-width: 112px;" onclick="this.children[1].style.display = this.children[1].style.display == 'block' ? 'none' : 'block'" onblur="this.children[1].style.display = 'none'">
                <div>Page layout ⯆</div>
                <div class="options">
                    <div onclick="changePageStyle('poem-centre')">Poem centre</div>
                    <div onclick="changePageStyle('poem-centre-wide')">Poem wide</div>
                    <div onclick="changePageStyle('centre')">Centre</div>
                </div>                
            </div>
            <div class="options-parent" style="width: 112px; min-width: 112px;" onclick="this.children[1].style.display = this.children[1].style.display == 'block' ? 'none' : 'block'" onblur="this.children[1].style.display = 'none'">
                <div>Background ⯆</div>
                <div class="options">
                    <div style="opacity: 0.6;">From link</div>
                    <div style="opacity: 0.6;">Upload file</div>
                    <div onclick="builtinFreePopup.style.display = 'block';">Built-in free</div>
                </div>                
            </div>
            <div onclick="alert('Error, try again later.')" style="width: 132px; min-width: 132px;"><div>Rhyme finder ➕</div></div>
            <div onclick="alert('Error, try again later.')" style="width: 132px; min-width: 132px;"><div>Auto rhythm ➕</div></div>
        </div>
        <hr>
    </div>

    <div style="position: absolute; left: 16px;display: flex;flex-direction: column;">
        Online editors:
        <div style="position: relative;margin-bottom: -16px; display: flex;">
            <img src="https://t3.ftcdn.net/jpg/03/64/62/36/360_F_364623623_ERzQYfO4HHHyawYkJ16tREsizLyvcaeg.jpg" style="border-radius: 100%;" width="64" height="64">
            <div style="padding: 4px;border-radius: 8px;background: linear-gradient(lightblue, blue);color: white;height: 16px;position: relative;align-self: center;">You</div>
        </div>
        <div style="position: relative;margin-bottom: -16px; display: flex;">
            <img src="https://t3.ftcdn.net/jpg/03/64/62/36/360_F_364623623_ERzQYfO4HHHyawYkJ16tREsizLyvcaeg.jpg" style="border-radius: 100%;" width="64" height="64">
            <div style="padding: 4px;border-radius: 8px;background: linear-gradient(lightblue, blue);color: white;height: 16px;position: relative;align-self: center;">You</div>
        </div>
        <div style="position: relative;margin-bottom: -16px; display: flex;">
            <img src="https://t3.ftcdn.net/jpg/03/64/62/36/360_F_364623623_ERzQYfO4HHHyawYkJ16tREsizLyvcaeg.jpg" style="border-radius: 100%;" width="64" height="64">
            <div style="padding: 4px;border-radius: 8px;background: linear-gradient(lightblue, blue);color: white;height: 16px;position: relative;align-self: center;">You</div>
        </div>
        <div style="position: relative;margin-bottom: -16px; display: flex;">
            <img src="https://t3.ftcdn.net/jpg/03/64/62/36/360_F_364623623_ERzQYfO4HHHyawYkJ16tREsizLyvcaeg.jpg" style="border-radius: 100%;" width="64" height="64">
            <div style="padding: 4px;border-radius: 8px;background: linear-gradient(lightblue, blue);color: white;height: 16px;position: relative;align-self: center;">You</div>
        </div>
    </div>

    <div id="main" class="poem-centre">
        <p id="content" contenteditable="true" onkeydown="checkReturn(event)" onpaste="checkPaste(event)">
            Click On Me to Start Editing
        </p>
        <p id="originalContent" style="display: none;"></p>
    </div>

    <div id="side" class="document-tools" collapsed="false">
        <div>
            <div style="display: flex;flex-direction: row;height: 48px;">
                <p style="margin: 0px; align-self: center;">Poem summary:</p>
            </div>
            <textarea id="summaryArea" type="text" maxlength="160"></textarea>
        </div>
        
        <div>
            <div style="display: flex;flex-direction: row;height: 48px;">
                <p style="margin: 0px; align-self: center;">Poem tags:</p>
            </div>

            <div id="tagContainer" style="background: var(--button-opaque);border-radius: 8px; display: grid; grid-template-columns: 33% 33% 33%; padding: 8px; grid-template-rows: auto auto;grid-gap: 2px;">
                <div style="border-radius: 4px;height:64px;background: lightgrey;padding: 4px; text-align: center;">War &amp; conflict</div>
                <div style="border-radius: 4px;height:64px;background: lightgrey;padding: 4px; text-align: center;">Society</div>
                <div style="border-radius: 4px;height:64px;background: lightgrey;padding: 4px; text-align: center;line-height: 64px;">+</div>
            </div>
        </div>

        <div>
            <div style="display: flex;flex-direction: row;height: 48px;">
                <p style="margin: 0px; align-self: center;">Content Warning:</p>
            </div>

            <div id="cWarningContainer" style="background: var(--button-opaque);border-radius: 8px; padding: 8px;">
                <input type="checkbox" id="cWarningCheckbox" onclick="cWarningNotesInput.disabled = this.checked ? false : true">
                <label for="cWarningCheckbox"> Enabled</label>
                <input type="text" id="cWarningNotesInput" placeholder="Additional warning notes" style="width: calc(100% - 5px); height: 24px;" disabled="">
            </div>
        </div>

        <button style="width: 100%;height: 32px;">Upload to site</button>

        <div style="width: 60%;height: 48px;border: 1px solid gray;position: relative;border-radius: 64px;align-self: center;margin-top: 32px;">
            <svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20" style="height: calc(100% - 16px);left: 50%;position: relative;transform: translateX(-50%);fill: gray;top: 8px;">
              <path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path>
            </svg>
        </div>
    </div>

    <a href="../contents" class="back"> <- Back</a>
</body>
<script>
    const ctx = signCanvas.getContext('2d', { willReadFrequently: true })
    const params = new URLSearchParams(document.location.search)
    const edit = params.get("edit")
    const amend = params.get("amend")
    const decoder = new TextDecoder()
    let poemTags = []

    //Make user confirm that they want to leave the page.
    window.onbeforeunload = () => {
        return "If you forgot, press cancel and 'save poem draft' to save before exiting!"
    }

    //format title to subliminal title format, used in poem save files
    let formatDash = (text) => text.trim().toLowerCase().replaceAll(" ", "-")

    let pageToHtml = text => {
      let htmlObject = document.createElement('body')
      htmlObject.innerHTML = text
      return htmlObject
    }

    function fetchStorage() {
        for (let i = 0; i < localStorage.length; i++) {
            let current = localStorage.getItem(localStorage.key(i))
            let cardEl = document.createElement("div")
            cardEl.className = "poem-card"
            cardEl.onclick = () => { loadKey(localStorage.key(i)); loadPoemPopup.style.display= "none"; }

            let cardTitle = document.createElement("h4")
            cardTitle.textContent = localStorage.key(i)
            cardEl.appendChild(cardTitle)
            
            let cardPreview = document.createElement("p")
            cardPreview.className = "poem-preview"
            let pContent
            try {
                pContent = JSON.parse(localStorage.getItem(localStorage.key(i))).poemContent
            }
            catch (e) {
                continue
            }
            cardPreview.textContent = pContent

            cardEl.appendChild(cardPreview)
            loadedContainer.appendChild(cardEl)
        }
    }

    function saveCurrent() {
        let saveData = {
            summary: summaryArea.value, //meta description
            tags: poemTags.toString(), //meta keywords
            cWarning: cWarningCheckbox.checked, //content warning
            cWarningAdditions: cWarningNotesInput.value, //content warning additional notes
            poemName: poemName.innerText,
            poemAuthor: poemAuthor.innerText, //poem header title
            poemContent: content.innerHTML, //poem html
            pageStyle: main.className, //poem visual format
            pageBackground: document.body.style.background //poem background image
        }
        localStorage.setItem(formatDash(poemName.innerText), JSON.stringify(saveData))

        //Refresh load box with latest poem.
        fetchStorage()
    }

    function loadKey(key) {
        let poemJson = JSON.parse(localStorage.getItem(key))
        load(poemJson)
    }

    function load(poemJson) {
        poemTags = []
        while (tagContainer.firstChild) {
            tagContainer.removeChild(tagContainer.firstChild)
        }

        if (poemJson.tags) {
            for(let t of poemJson.tags?.split(",")) {
                addPoemTag(t)
            }
        }

        summaryArea.value = poemJson.summary || ""
        cWarningCheckbox.checked = poemJson.cWarning || ""
        cWarningNotesInput.disabled = poemJson.cWarning ? false : true
        cWarningNotesInput.value = poemJson.cWarningAdditions || ""
        poemName.innerText = poemJson.poemName || "undefined"
        poemAuthor.innerText = poemJson.poemAuthor || "undefined"
        content.innerHTML = poemJson.poemContent || "undefined"
        document.body.style.background = poemJson.pageBackground || ""
        main.className = poemJson.pageStyle || "poem-centre"
    }

    //This itelf is just the poem-editor, content will be moved from here to a new template file, and then downloaded
    async function download() {
        saveCurrent()
        let loadObject = JSON.parse(localStorage.getItem(formatDash(poemName.innerText)))
        let poemTemplate = await (await fetch("Other/poem-template.html")).text()
        let cWTemplate = await (await fetch("Other/content-warning-template.html")).text()

        let finishedCWTemplate
        if (loadObject.cWarning === true) {
            //split into chunks of max length 55, full cw line is 59 (pipe space, space pipe) + \n
            let chunks = loadObject.cWarningAdditions.match(/.{1,55}/g), cwInsert = ""
            for (let chunk of chunks) {
                chunk = chunk.padEnd(55) //if not taking up a whole line (is 55 chars long), pad spaces to line up
                chunk = "| ".concat(chunk) //add pipe start
                chunk = chunk.concat(" |") //add pipe end
                cwInsert = cwInsert.concat("\n", chunk) //Add \n followed by chunk to end of cwinsert
            }
            finishedCWTemplate = cWTemplate.replace("ADDITIONAL_NOTES", cwInsert)
        }

        let finishedPoemTemplate = poemTemplate
            .replace("NAME", loadObject.poemName)
            .replace("SUMMARY", loadObject.summary)
            .replace("TAGS", loadObject.tags)
            .replace("POEM_BACKGROUND", loadObject.pageBackground)
            .replace("TITLE", loadObject.poemName + " - By " + loadObject.poemAuthor)
            .replace("POEM_STYLE", loadObject.pageStyle)
            .replace("CONTENT", loadObject.poemContent.replaceAll("<br>", "<br>\n"))
            .replace("CONTENT_WARNING", finishedCWTemplate ? finishedCWTemplate : "")
            .replace("DATE", "<!--" + Date.now().toString() + "-->")

        let element = document.createElement('a')
        element.setAttribute('href', 'data:text/html;charset=UTF-8,' + encodeURIComponent(finishedPoemTemplate));
        element.setAttribute('download', formatDash(poemName.innerText) + ".html");
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        confirm("Page sucessfully created!\nDownload and create a pull request on github, in order to have your new poem merged into the main site.");
    }

    // TEST:
    // let number = 255
    // let gen = number
    // let shift = 0
    // gen ^= 1 << (7 - shift)
    // We pad the leading number because JS numbers can't have leading zeros
    // console.log(number.toString(2).padStart(8, 0) + " : " + gen.toString(2).padStart(8, 0) + " -> " + gen)
    function getSignCanvasBits() {
        let bufWidth = signCanvas.width / 8, bufHeight = signCanvas.height
        let buffer = new Uint8Array(bufWidth * bufHeight).fill(255) //11111111
        let data = ctx.getImageData(0, 0, signCanvas.width, signCanvas.height, { colorSpace: "srgb" }).data

        for (let h = 0; h < signCanvas.height; h++) {
            for (let w = 0; w < signCanvas.width; w++) {
                let byteI = Math.floor((signCanvas.width * h + w) / 8)
                let shiftI = w % 8

                // We use 4n (n = pixel iteration we are looking at) - 1 to get where 255 (for black) would be.
                // We set the bit to zero if the color at this position is not black
                if (data[4 * (signCanvas.width * h + w) + 3] == 0) buffer[byteI] ^= 1 << (7 - shiftI)
            }
        }

        return buffer
    }

    function uploadCurrent() {
        saveCurrent()
        let loadObject = JSON.parse(localStorage.getItem(formatDash(poemName.innerText)))
        
        //Only apply if they actually used the signature
        let signBits = getSignCanvasBits()
        if (!signBits.every(item => item === 0)) {
            loadObject.signature = window.btoa(String.fromCharCode(...new Uint8Array(signBits)))
        }

        //WARNING: Calling async function without await may cause issues
        upload(loadObject) 
    }

    async function upload(poemJson) {
        if (await isLoggedIn()) poemJson.code = localStorage.accountCode

        fetch("https://server.poemanthology.org:81/PurgatoryUpload", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(poemJson)
        }).then(res => {
            if (!res.ok) {
                console.error("Cricical error in uploading" + res)
                licenseAgreePopup.style.display = "none"
                alert("Sorry! 😭\n\nFailed to upload poem to purgatory. Maybe try again...")
                return null
            }

            return res.text()
        })
        .then(guidResponse => {            
            if (guidResponse == null) return

            console.log("Upload sucessful, redirecting.")
            window.onbeforeunload = () => {} 
            window.location.href = "./contents?purgatorynew=" + guidResponse
        })
    }

    function format(command, value) {
        document.execCommand(command, false, value);
        document.getElementById("content").focus();
    }

    function formatCustom(tag) {
        selectionText = window.getSelection(); //TODO: Make this toggle-able, like the rest.
        document.execCommand("insertHTML", false, "<"+tag+">" + selectionText + "</"+tag+">");
        document.getElementById("content").focus();
    }

    function formatImage() {
        console.log(window.opener.document.getElementById("content").selectionStart);
    }

    function changePageStyle(newStyle) {
        document.getElementById("main").className = newStyle;
    }

    //PATCH: To get chrome support for proper <br> based formatting, instead of divs for each line.
    function checkReturn(event) {
        if (event.key === 'Enter') {
            document.execCommand("insertLineBreak")
            event.preventDefault()
        }
    }
    //PATCH: Stop pasting weird formatted text that could break things.
    function checkPaste(event) {
        event.preventDefault()
        const text = event.clipboardData.getData('text/plain')
        text.replace("\n", "<br>")
        document.execCommand("insertText", false, text)
    }

    function handleBackgroundDrop(event) {
        const reader = new FileReader();
        reader.readAsDataURL(event.files[0]);
        reader.onloadend = () => {
            document.body.style.background = `url('${reader.result}')`;
        }
    }

    function addPoemTag(tagName) {
        if (!tagName) return
        poemTags.push(tagName)
        let newTag = document.createElement("button")
        newTag.innerText = tagName
        newTag.onclick = () => { removePoemTag(tagName) }
        tagContainer.appendChild(newTag)
    }

    function removePoemTag(tagName) {
        poemTags.splice(poemTags.indexOf(tagName), 1)
        for (let t of tagContainer.children) {
            if (t.innerText == tagName)
                tagContainer.removeChild(t)
        }
    }


    function signCanvasDown(e) {
        let relativeX = (e.offsetX / signCanvas.offsetWidth * signCanvas.width), relativeY = (e.offsetY / signCanvas.offsetHeight * signCanvas.height)
        this.down = true
        this.X = relativeX
        this.Y = relativeY
        this.color = 'rgb(0, 0, 0)'
        e.preventDefault()
    }

    function signCanvasUp(e) {
        this.down = false
        e.preventDefault()
    }

    function signCanvasDrag(e) {
        e.preventDefault()
        let relativeX = (e.offsetX / signCanvas.offsetWidth * signCanvas.width), relativeY = (e.offsetY / signCanvas.offsetHeight * signCanvas.height)
        if (!this.down) return
        ctx.beginPath()
        ctx.moveTo(this.X, this.Y)
        ctx.lineCap = 'round'
        ctx.lineWidth = 3
        ctx.lineTo(relativeX , relativeY )
        ctx.strokeStyle = this.color
        ctx.stroke()
        this.X = relativeX
        this.Y = relativeY
    }

    async function fetchPathJson(path) {
        let json = {}

        if (path.includes("/")) {
            let data = await fetch(window.location.protocol + "\/\/" + window.location.hostname + path)
            json = await data.json()
        }
        else {
            json = await (await fetch("https://server.poemanthology.org:81/Purgatory/" + path)).json()
        }

        return json
    }

    async function amendMode() {
        downloadButton.setAttribute("disabled", true)
        uploadButton.setAttribute("disabled", true)
        saveButton.setAttribute("disabled", true)
        loadButton.setAttribute("disabled", true)
        loadPoemPopup.style.display = 'none'
        amendButton.style.display = "block"
        originalContent.style.display = "block"
        originalContent.style.top = content.offsetTop + "px"
        originalContent.style.maxWidth = content.offsetWidth + "px"

        //Load up amendment poem
        let currentJson = await fetchPathJson(amend)
        originalContent.innerHTML = currentJson.poemContent || ""
        currentJson.amends = amend
        load(currentJson)
    }

    async function editMode() {
        loadPoemPopup.style.display = 'none'
        let currentJson = await fetchPathJson(edit)
        currentJson.edits = edit
        load(currentJson)
    }

    if (amend) amendMode() //enter poem amendment mode
    else if (edit) editMode()
    else fetchStorage() //Load saved poems from local storage

    formattingToolbar.addEventListener("mousemove", event => {
        for (let button of formattingToolbar.children) {
            if (button.className == "separator") continue
            button.style.background = 'radial-gradient(at left ' + (event.screenX - button.offsetLeft) + 'px top ' + (event.screenY - button.offsetTop) + 'px, darkgray, white)'
        }
    })

    this.addEventListener('resize', event => {
        originalContent.style.top = content.offsetTop + "px"
        originalContent.style.maxWidth = content.offsetWidth + "px"
    })
</script>
</html>

<!--
else { //DEPRECATED: Maybe this can be refitted for loading up downloaded poem HTML files
    let poemHtml = pageToHtml(await data.text())
    json = {
        //Summary, tags, content warning, etc is unrecoverable with poems web1 poems, so we use default values
        poemName: poemHtml.querySelector("body > div> h2").innerText.split(" - By ")[0],
        poemAuthor: poemHtml.querySelector("body > div> h2").innerText.split(" - By ")[1],
        poemContent: poemHtml.querySelector("body div > p").innerHTML, //poem html
        pageStyle: poemHtml.querySelector("body div:has(p)").className, //poem visual format
        pageBackground: poemHtml.style.background, //poem background image
        amends: edit
    }
}
-->
