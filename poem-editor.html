<!DOCTYPE html>
<html>
<head>
    <title>Subliminal</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="../styles.css">
    <script type="text/javascript">
        let poemTags = []

        //Make user confirm that they want to leave the page.
        window.onbeforeunload = () => {
            if (confirm("Save before exiting?")) save()
            return true
        }

        //Load saved poems from local storage
        window.onload = () => {
            fetchStorage();
        }

        function fetchStorage() {
            document.getElementById("loadDiv").innerHTML = "Load: <br>";
            for (let i = 0; i < localStorage.length; i++) {
                let current = localStorage.getItem(localStorage.key(i));
                document.getElementById("loadDiv").innerHTML += `<input class="tool" onclick="load('${localStorage.key(i)}')" type="button" value="${localStorage.key(i)}"> <br>`;
            }
        }

        function save() {
            let title = document.getElementById("title");
            let content = document.getElementById("content");
            let saveData = {
                summary: summaryArea.value, //meta description
                tags: poemTags.toString(), //meta keywords
                title: title.innerHTML.split("- By")[0].trim(), //meta title
                cWarning: cWarningCheckbox.checked, //content warning
                cWarningAdditions: cWarningNotesInput.value, //content warning additional notes
                fullTitle: title.innerHTML, //poem header title
                poemContent: content.innerHTML, //poem html
                pageStyle: document.getElementById("main").className, //poem visual format
                pageBackground: document.body.style.background //poem background image
            }
            localStorage.setItem(title.innerText.split("- By")[0].trim().toLowerCase().replaceAll(" ", "-"), JSON.stringify(saveData));
            
            //Refresh load box with latest poem. 
            fetchStorage();
        }

        function load(key) {
            let loadObject = JSON.parse(localStorage.getItem(key));
            summaryArea.value = loadObject.summary;
            poemTags = []
            while (tagContainer.firstChild) {
                tagContainer.removeChild(tagContainer.firstChild);
            }
            for(let t of loadObject.tags.split(",")) { 
                addPoemTag(t)
            }
            cWarningCheckbox.checked = loadObject.cWarning
            cWarningNotesInput.disabled = loadObject.cWarning ? false : true
            cWarningNotesInput.value = loadObject.cWarningAdditions
            title.innerHTML = loadObject.fullTitle;
            content.innerHTML = loadObject.poemContent;
            document.body.style.background = loadObject.pageBackground;
            document.getElementById("main").className = loadObject.pageStyle;
        }

        //This itelf is just the poem-editor, content will be moved from here to a new template file, and then downloaded
        async function download() {
            save()
            let loadObject = JSON.parse(localStorage.getItem(title.innerText.split("- By")[0].trim().toLowerCase().replaceAll(" ", "-")));
            let poemTemplate = await (await fetch("Other/poem-template.html")).text()
            let cWTemplate = await (await fetch("Other/content-warning-template.html")).text()

            let finishedCWTemplate
            if (loadObject.cWarning === true) {
                //split into chunks of max length 55, full cw line is 59 (pipe space, space pipe) + \n
                let chunks = loadObject.cWarningAdditions.match(/.{1,55}/g), cwInsert = ""
                for (let chunk of chunks) {
                    chunk = chunk.padEnd(55) //if not taking up a whole line (is 55 chars long), pad spaces to line up
                    chunk = "| ".concat(chunk) //add pipe start
                    chunk = chunk.concat(" |") //add pipe end
                    cwInsert = cwInsert.concat("\n", chunk) //Add \n followed by chunk to end of cwinsert
                }
                finishedCWTemplate = cWTemplate.replace("ADDITIONAL_NOTES", cwInsert)
            }

            let finishedPoemTemplate = poemTemplate
                .replace("NAME", loadObject.title)
                .replace("SUMMARY", loadObject.summary)
                .replace("TAGS", loadObject.tags)
                .replace("POEM_BACKGROUND", loadObject.pageBackground)
                .replace("TITLE", loadObject.fullTitle)
                .replace("POEM_STYLE", loadObject.pageStyle)
                .replace("CONTENT", loadObject.poemContent.replaceAll("<br>", "<br>\n"))
                .replace("CONTENT_WARNING", finishedCWTemplate ? finishedCWTemplate : "")
                .replace("DATE", "<!--" + Date.now().toString() + "-->")

            console.log("a" + finishedPoemTemplate)

            let element = document.createElement('a')
            element.setAttribute('href', 'data:text/html;charset=UTF-8,' + encodeURIComponent(finishedPoemTemplate));
            element.setAttribute('download', title.innerText.split("- By")[0].trim().toLowerCase().replaceAll(" ", "-") + ".html");
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            confirm("Page sucessfully created!\nDownload and create a pull request on github, in order to have your new poem merged into the main site.");
        }

        function format(command, value) {
            document.execCommand(command, false, value);
            document.getElementById("content").focus();
        }

        function formatCustom(tag) {
            selectionText = window.getSelection(); //TODO: Make this toggle-able, like the rest.
            document.execCommand("insertHTML", false, "<"+tag+">" + selectionText + "</"+tag+">");
            document.getElementById("content").focus();
        }

        function formatImage() {
            console.log(window.opener.document.getElementById("content").selectionStart);
        }

        function changePageStyle(newStyle) {
            document.getElementById("main").className = newStyle;
        }

        //PATCH: To get chrome support for proper <br> based formatting, instead of divs for each line.
        function checkReturn(event) {
            if (event.key === 'Enter') {
                document.execCommand("insertLineBreak");
                event.preventDefault();
            }
        }
        //PATCH: Stop pasting weird formatted text that could break things.
        function checkPaste(event) {
            event.preventDefault();
            const text = event.clipboardData.getData('text/plain');
            text.replace("\n", "<br>")
            document.execCommand("insertHTML", false, text);
        }

        function handleBackgroundDrop(event) {            
            const reader = new FileReader();
            reader.readAsDataURL(event.files[0]);
            reader.onloadend = () => {
                document.body.style.background = `url('${reader.result}')`;
            }
        }

        function addPoemTag(tagName) {
            poemTags.push(tagName)
            let newTag = document.createElement("button")
            newTag.innerText = tagName
            newTag.onclick = () => { removePoemTag(tagName) }
            tagContainer.appendChild(newTag)
        }

        function removePoemTag(tagName) {
            poemTags.splice(poemTags.indexOf(tagName), 1)
            for (let t of tagContainer.children) {
                if (t.innerText == tagName)
                    tagContainer.removeChild(t)
            }
        }
    </script>
    <style>
        .tool {
            margin: 1px;
            height: 24px;
            max-width: 100%;
        }
        .text-tools {
            position: fixed;
            top: 115px;
            left: 16px;
            border: 1px solid black;
            width: 160px;
            padding: 5px;
            border-radius: 2px;
            background-color: rgba(255, 255, 255, .2);
            backdrop-filter: blur(5px);
            box-shadow: 0px 2px 4px gray;
            z-index: 1;
        }
        .document-tools {
            position: fixed;
            top: 115px;
            right: 16px;
            border: 1px solid black;
            width: 180px;
            padding: 5px;
            border-radius: 2px;
            background-color: rgba(255, 255, 255, .2);
            backdrop-filter: blur(5px);
            box-shadow: 0px 2px 4px gray;
            z-index: 1;
        }

        #poem-tags button {
            border-radius: 4px;
            margin: 2px;
        }

        #licenseAgreePopup {
            position:absolute;
            left:50%;
            top:50%;
            transform:translate(-50%,-50%);
            border-radius:8px;
            padding:8px;
            box-shadow:0 0 16px #000;
            z-index:3;
            backdrop-filter:blur(16px);
            width: 50%;
        }
        #signCanvas {
            background:#f2f2f2;
            width:50%;
            height:50%;
            border-radius:4px
        }
        .sign-container {
            display:flex;
            flex-direction:column;
            justify-content:center;
            align-content:center;
            row-gap:4px;
            align-items:center;
            user-select:none;
        }
        .sign-buttons {
            display:flex;
            column-gap:8px;
            width:50%;
        }
        .sign-buttons div {
            font-family: Arial, Helvetica, sans-serif;
            border-radius:4px;
            padding:8px;
            flex-grow: 1;
            text-align:center;
            cursor:pointer;
        }
        
        @media screen and (orientation:portrait) {
            .text-tools { position: inherit !important; width: calc(100% - 12px); } 
            .document-tools { position: inherit !important; width: calc(100% - 12px); }
        }
    </style>
</head>
 <!--TODO: Ability to import webpages and edit them.-->
<body>
    <div id="licenseAgreePopup">
        <h2>License agreement:</h2>
        <p>All content on this site must be licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0, in order to make open source contribution easy, with the underlying source code used to format and display that content licensed under the GNU GPL-3 license. Summaries of these licenses are available at CC BY-NC-SA and GPL-3.</p>
        <p>By uploading your work to this site, you give consent for your poem to be licensed under Creative Commons Attribution-NonCommercial-ShareAlike 4.0.</p>
        <p>You also agree to allow us permission to store and process your work. We can also accept no responsibility, if you write something that gets you in trouble with people you know, an institution, or local government, you agree that you WILLINGLY chose to upload it here, however we will always try . We accept no responsibility how your work is interpreted, and what consequences may or may not come as a result of it.</p>
        <p>You will always be the lone copyright owner of your work, we will never, ever take ownership of what you made from you, and we will always comply if you ask for your poem to be modified, and or taken down from this site.</p>
        <p>If you think the terms we have laid out here are reasonable, and agree to all, please <strong>sign</strong> below.</p>
        <div class="sign-container">
           <canvas id="signCanvas"></canvas>
           <div class="sign-buttons">
              <div style="background-color:#8ad783;">Smooth</div>
              <div style="background-color:#ff5d5d;">Clear</div>
              <div style="background-color:#f2f2f2;box-shadow:0 0 3px #000;">Submit</div>
           </div>
        </div>
        <p style="opacity:0.6;"><em>(signatures will be stored securely on our servers in order to verify you are the owner of your work, and never released publicly)</em></p>
    </div>
     
    <div class="title-blur" style="z-index: 2;">
        <h2 class="centre" id="title" contenteditable="true" onpaste="checkPaste()" onkeydown="if(event.key === 'Enter') { event.preventDefault(); return false; }" >Click On Me to Start Editing - By Click On Me to Start Editing</h2>
        <hr>
    </div>
    <div style="position: fixed; top: 90px;">
    </div>
    <div class="text-tools">
        Tools: <br>
        <input class="tool" onclick="format('bold', null)" type="button" value="Bold">
        <input class="tool" onclick="format('italic', null)" type="button" value="Italic">
        <input class="tool" onclick="formatCustom('code')" type="button" value="Code" disabled> <br>
        <input class="tool" onclick="format('superscript', null)" type="button" value="Superscript">
        <input class="tool" onclick="format('subscript', null)" type="button" value="Subscript"> <br>
        <input class="tool" onchange="format('foreColor', this.value);" value="#000000" style="height: 32px;" type="color"> <br>
        <input class="tool" onclick="formatImage()" type="button" value="Image" disabled> <br>
        <input class="tool" onclick="format('undo', null)" type="button" value="↩ undo">
        <input class="tool" onclick="format('redo', null)" type="button" value="redo ↪"> <br>
        <select class="tool" onchange="changePageStyle(value)" style="margin-top: 5px;">
            <option value="poem-centre" selected>Poem Centre</option>
            <option value="poem-centre-wide">Poem Centre Wide</option>
            <option value="centre">Centre</option>
        </select> <br>
        Background image: <br>
        <input type="file" multiple accept="image/*" onchange="handleBackgroundDrop(this)" style="width: 100%;">
        Poem summary: <br>
        <textarea id="summaryArea" type="text" maxlength="160" style="min-height: 50px; width: calc(100% - 5px); height: 50px; max-width: calc(100% - 5px); max-height: 150px;"></textarea>
        Poem tags: <br>
        <div id="tagContainer"></div>
        <input type="text" placeholder="Add new tag" style="width: calc(100% - 5px); height: 24px;" onkeypress="if (this.value.trim() == '') return; let add = () => { addPoemTag(this.value); this.value = '' }; if (event.key == 'Enter') { add() } else if (event.key == 'Space') { this.spaces++; if (this.spaces < 2) return; add(); this.spaces = 0 }">
        Content Warning: <br>
        <input type="checkbox" id="cWarningCheckbox" onclick="cWarningNotesInput.disabled = this.checked ? false : true"/>
        <label for="cWarningCheckbox"> Enabled</label><br>
        <input type="text" id="cWarningNotesInput" placeholder="Additional warning notes" style="width: calc(100% - 5px); height: 24px;" disabled>
    </div>
    <div id="toolbox" class="document-tools">
        Document Management: <br>
        <input class="tool" onclick="save()" type="button" value="Save draft poem 💾" style="width: 100%;height: 32px;margin-top: 8px;">
        <div style="margin: 2px;border: 1px solid black;padding: 5px;margin-top: 8px;" id="loadDiv">Load: <br></div>
        <button id="download-button" onclick="download()" style="position: relative;height: 32px;width: 100%;margin-top: 8px;">
            <div style="display: none; position: absolute;background-color: white;border-radius: 4px;box-shadow: 0px 0px 4px 0px black;left: calc( -100% - 16px);width: 100%;z-index: 1;top: 0px;pointer-events: none;">This will download a formatted subliminal HTML file, containing the whole page for your created poem.<br><br>You can then visit the <a href="https://github.com/Zekiah-A/Subliminal">github</a>, and create a pull request, to have your poem reviewed, and added to the site.</div>
            Download edited page
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" fill="none" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" stroke-width="2" xmlns:v="https://vecta.io/nano" width="18px" style="transform: translateY(8px);">
              <path d="M36.5 17v32.761m-8.695-8.116L36.5 50.31l8.695-8.665M27.5 55h18"></path>
           </svg>
        </button>
        <button id="uploadButton" onclick="upload()" style="position: relative;height: 32px;width: 100%;margin-top: 8px;">
            <div style="display: none; position: absolute;background-color: white;border-radius: 4px;box-shadow: 0px 0px 4px 0px black;left: calc( -100% - 16px);width: 100%;z-index: 1;top: 0px;pointer-events: none;">This will send your poem to the <strong>poem purgatory</strong> section of the site, where anyone can view it immediately.<br><br><em>Note: Anyone will be able to rate your poem, if it gets enough approvals, it will officially be added to the site.</em></div>
            Upload to site 📨
        </button>
     </div>
    <div id="main" class="poem-centre">
        <p id="content" contenteditable="true" onkeydown="checkReturn(event)" onpaste="checkPaste(event)">
            Click On Me to Start Editing
        </p>
    </div>
    <a href="../contents" class="back"> <- Back</a>
</body>
</html>

<!--
    var canvas = document.getElementById('signCanvas');
    var ctx = canvas.getContext('2d');
    canvas.height = 200;
    canvas.width = 300;
    canvas.addEventListener('mousedown', function(e) {
      this.down = true;  
      this.X = e.offsetX ;
      this.Y = e.offsetY ;
      this.color = 'rgb(0, 0, 0)';
    }, 0);
    canvas.addEventListener('mouseup', function() {
      this.down = false;      
    }, 0);
    canvas.addEventListener('mousemove', function(e) {
      this.style.cursor = 'pointer';
      if(this.down) {
          ctx.beginPath();
          ctx.moveTo(this.X, this.Y);
          ctx.lineCap = 'round';
          ctx.lineWidth = 3;
          ctx.lineTo(e.offsetX , e.offsetY );
          ctx.strokeStyle = this.color;
          ctx.stroke();

         this.X = e.offsetX - canvas.width ;
         this.Y = e.offsetY - canvas.height ;
      }
    }, 0);
-->