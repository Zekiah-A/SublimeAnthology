<!DOCTYPE html>
<html>
<head>
    <title>Subliminal Sounds</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="Resources/SoundsLogo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sounds at subliminal!">
    <meta name="keywords" content="Spotify, Music, Sounds, Subliminal, Lyrics">
    <link rel="stylesheet" href="styles.css">
    <style>
        * {
            font-family: Arial, Helvetica, sans-serif;
        }
        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body {
            background-color: #121212;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 0px;
            margin: 0px;
        }
        p, span, h1, h2, h3, h4 {
            user-select: none;
        }
        .side-header-container {
            position: relative;
            display: flex;
            flex-direction: row;
            padding: 8px;
            column-gap: 8px;
            align-content: center;
            margin-bottom: 16px;
            margin-top: 16px;
            white-space: nowrap;
        }
        .side-button {
            padding: 4px;
            border-radius: 4px;
            color: lightgray;
            height: fit-content;
            margin: 8px 8px 0px 8px;
            line-height: 16px;
            user-select: none;
            cursor: pointer;
            text-decoration: none;
            height: 30px;
        }
        .side-button:hover {
            color: white;
        }
        .side-button:focus {
            background-color: #d3d3d33b;
        }
        .side-title {
            color: white;
            font-size: 20px;
            user-select: none;
            margin: 0px;
        }
        .side-motto {
            color: white;
            font-style: italic;
            opacity: 0.6;
            user-select: none;
        }
        .side-logo {
            height: 50%;
            align-self: center;
            opacity: 0.6;
            height: 40px;
        }
        .main-content-page {
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0px;
            left: 0px;
            overflow-y: scroll;
        }
        .main-content-page:target {
            opacity: 1;
            pointer-events: all;
        }
        .main-content-page-topsection {
          height: 4vh;
          display: flex;
          align-content: center;
          position: relative;
        }
        .home-genres-grid {
            display: grid;
            margin: 32px;
            column-gap: 32px;
            grid-template-columns: auto auto auto;
            grid-template-rows: auto auto;
            row-gap: 16px;
            user-select: none;
        }
        .home-genres-grid > div { 
            background: #181818;
            border-radius: 4px;
            box-shadow: 0px 8px 16px #00000038;
            width: 100%;
            height: 96px;
            color: white;
            font-weight: bold;
            display: flex;
            flex-direction: row;
            column-gap: 16px;
            max-width: 100%;
            overflow: hidden;
            backdrop-filter: contrast(0.8);
            cursor: pointer;
        }
        .home-genres-grid > div:hover {
            background:#282828;
        }
        .home-genres-grid > div img {
            height: 100%;
            border-radius: 4px;
        }
        .home-genres-grid > div span {
            line-height: 96px;
        }
        .home-cards-grid {
            display: grid;
            column-gap: 32px;
            row-gap: 32px;
            margin-left: 32px;
            margin-right: 32px;
        }
        .home-cards-grid > div {
            border-radius: 8px;
            background:#181818;
            cursor: pointer;
            transition: background-color .3s ease;
        }
        .home-cards-grid > div:hover {
            background:#282828;
        }
        .home-cards-grid > div > img {
            width: calc(100% - 34px);
            margin: 16px;
            border-radius: 8px;
            border: 1px solid gray;
            box-shadow: 0px 0px 8px 0px #00000047;
        }
        @media (orientation: portrait) {
            .home-genres-grid {
                margin: 16px;
                column-gap: 8px;
                grid-template-columns: auto auto;
                grid-template-rows: auto auto auto;
                row-gap: 8px;
            }
            .home-genres-grid > div {
                height: 84px;
            }
        }
        input[type="range"] {
            border: none;
            appearance: none;
            outline: none;
            cursor: pointer;
            overflow: clip;
            height: 4px;
            border-radius: 4px;
        }
        input[type="range"]::-moz-range-thumb {
            appearance: none;
            height: 100%;
            background: #096BB1;
            cursor: pointer;
            transform: translateX(-10px);
            width: 20px;
            box-shadow: -1010px 0px 0px 1000px #096bb1;
            border: none;
            border-radius: 0px 10px 10px 0px;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            height: 100%;
            background: #096BB1;
            cursor: pointer;
            transform: translateX(-10px);
            width: 20px;
            box-shadow: -1010px 0px 0px 1000px #096bb1;
            border: none;
            border-radius: 0px 10px 10px 0px;
        }
        input[type="text"] {
            height: 100%;
            border-radius: 96px;
            padding: 16px;
            border: 1px solid black;
            background-color: white;
            width: 300px;
            padding-left: 32px;
            outline: none;
        }
        
        #main {
            flex-grow: 1;
            display: flex;
            flex-direction: row;
        }
        #side {
            width: 256px;
            background-color: black;
            border-right: 1px solid #242424;
            display: flex;
            flex-direction: column;
        }
        #sideBurger {
          display: none;
        }
        #mainContent {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        /*on mobile, give nav a 100% width when it is opened, and hide when collapsed, making the main content 100% of the width*/
        @media (orientation: portrait) {
            #main {
              flex-direction: column;
            }
            #side {
                height: 78px;
                width: 100%;
                overflow: hidden;
                transition: height .5s;
            }
            #side:target {
                display: flex;
                width: 100%;
                height: 100%;
            }
            #sideBurger {
              display: block;
              position: absolute;
              right: 40px;
              top:5%;
              transform: translateY(-50%);
              color: white;
              display: block;
              width: 48px;
              height: 32px;
              border: 1px solid gray;
              border-radius: 4px;
              z-index: 1;
            }
            #sideBurger > svg {
                fill: white; opacity: 0.6;
            }
            #mainContent:target-within { /*may not be necessary, but for good measure*/
                width: 100%;
                flex-grow: 1;
            }
        }

        #playerBar {
            background-color: #303030;
            width: 100%;
            height: 96px;
            box-shadow: 0px 0px 16px 0px #00000040;
            border-bottom: 2px solid #007bd3;
            border-top: 1px solid #3c3c3c;
            align-self: flex-end;
            position: relative;
            display: flex;
            flex-direction: row;
            justify-content: center;
            justify-content: space-evenly;
            white-space: nowrap;
        }
        #playButton {
            color: black;
            background-color: white;
            border-radius: 100%;
            width: 32px;
            height: 32px;
            line-height: 50px;
            text-align: center;
            cursor: pointer;
            margin: 4px;
            transition: scale(0.2s);
            display: flex;
            justify-content: center;
            align-content: center;
        }
        #playButton:hover {
            scale: 1.1;
        }
        #progressBar {
            position: absolute;
            left: 50%;
            bottom: 20%;
            transform: translateY(-50%) translateX(-50%);
            width: 80%;
        }
        #lyricsLines {
            position: absolute;
            width: 85%;
            left: 50%;
            transform: translateX(-50%);
            padding-left: 15%;
            white-space: nowrap;
        }
        #lyricsLines span {
            font-size: 300%;
            font-weight: bolder;
            display: inline-block;
            align-self: center;
            margin: 0px;
            cursor: pointer;
            transition: color .1s, opacity .1s;
        }
        #lyricsLines span:hover {
            color: white;
            opacity: 0.9;
        }
        #lyricsLines span[status="later"] {
            color: #333333;
            opacity: 0.6;
        }  
        #lyricsLines span[status="now"] {
            color: white;
            opacity: 1;
        }
        #lyricsLines span[status="before"] {
            color: white;
            opacity: 0.6;
        }
        #lyricsLines span[mode="addition"] {
            display: inline;
        }
        #lyricsLines span[mode="addition"][status="later"] {
            display: none;
        }
        #lyricsCanvas {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /*
        .encore-dark-theme, .encore-dark-theme .encore-base-set {
            --background-base: #121212;
            --background-highlight: #1a1a1a;
            --background-press: #000;
            --background-elevated-base: #242424;
            --background-elevated-highlight: #2a2a2a;
            --background-elevated-press: #000;
            --background-tinted-base: hsla(0,0%,100%,.07);
            --background-tinted-highlight: hsla(0,0%,100%,.1);
            --background-tinted-press: hsla(0,0%,100%,.04);
            --background-unsafe-for-small-text-base: #121212;
            --background-unsafe-for-small-text-highlight: #121212;
            --background-unsafe-for-small-text-press: #121212;
            --text-base: #fff;
            --text-subdued: #a7a7a7;
            --text-bright-accent: #1ed760;
            --text-negative: #f15e6c;
            --text-warning: #ffa42b;
            --text-positive: #1ed760;
            --text-announcement: #3d91f4;
            --essential-base: #fff;
            --essential-subdued: #727272;
            --essential-bright-accent: #1ed760;
            --essential-negative: #e91429;
            --essential-warning: #ffa42b;
            --essential-positive: #1ed760;
            --essential-announcement: #0d72ea;
            --decorative-base: #fff;
            --decorative-subdued: #292929;
        }

        inner-card: background-color: var(--card-color,#333)
        card-box-shadow: box-shadow: 0 8px 24px rgba(0,0,0,.5);
        */
    </style>
</head>

<body>
    <div id="main">
        <div id="side">
            <a id="sideBurger" href="#side">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="32" width="48"><path d="M6 36v-3h36v3Zm0-10.5v-3h36v3ZM6 15v-3h36v3Z"/></svg>
            </a>
            <div class="side-header-container">
                <img class="side-logo" src="Resources/SoundsLogo.png">
                <a href="#home" style="text-decoration: none;">
                    <div style="align-self: center;">
                        <h1 class="side-title">Subliminal sounds</h1>
                        <span class="side-motto">Sound, unhinged</span>
                    </div>
                </a>
            </div>
            <a class="side-button" href="#home" style="display: flex;align-items: center;">
                <svg role="img" height="24" width="24" aria-hidden="true" viewBox="0 0 24 24" style="fill: white;opacity: 0.6;/*! scale: 2.5; */display: inline;">
                   <path d="M14.5 2.134a1 1 0 011 0l6 3.464a1 1 0 01.5.866V21a1 1 0 01-1 1h-6a1 1 0 01-1-1V3a1 1 0 01.5-.866zM16 4.732V20h4V7.041l-4-2.309zM3 22a1 1 0 01-1-1V3a1 1 0 012 0v18a1 1 0 01-1 1zm6 0a1 1 0 01-1-1V3a1 1 0 012 0v18a1 1 0 01-1 1z"></path>
                </svg> 
                <span>&nbsp; Home</span>
             </a>
            <a href="#search" class="side-button">
               <div style="background-color: white;padding: 10px;height: 10px;width: 10px;display: inline-flex;border-radius: 2px;opacity: 0.6;">
                  <svg role="img" height="12" width="12" aria-hidden="true" viewBox="0 0 16 16" style="align-self: center;">
                     <path d="M15.25 8a.75.75 0 01-.75.75H8.75v5.75a.75.75 0 01-1.5 0V8.75H1.5a.75.75 0 010-1.5h5.75V1.5a.75.75 0 011.5 0v5.75h5.75a.75.75 0 01.75.75z"></path>
                  </svg>
               </div>
               <span>Search Songs</span>
            </a>
            <a href="#liked" class="side-button">
               <div style="background-color: white;padding: 10px;height: 10px;width: 10px;display: inline-flex;border-radius: 2px;opacity: 0.6;background: linear-gradient(135deg,#3d00f4,#e88d8d);">
                  <svg role="img" height="12" width="12" aria-hidden="true" viewBox="0 0 16 16" style="fill: white;">
                     <path d="M15.724 4.22A4.313 4.313 0 0012.192.814a4.269 4.269 0 00-3.622 1.13.837.837 0 01-1.14 0 4.272 4.272 0 00-6.21 5.855l5.916 7.05a1.128 1.128 0 001.727 0l5.916-7.05a4.228 4.228 0 00.945-3.577z"></path>
                  </svg>
               </div>
               <span>Liked songs</span>
            </a>
        </div>
        <div id="mainContent">
            <!--Home page, only visible when current anchor is #home-->
            <div id="home" class="main-content-page" style="background: linear-gradient(#ffffff47 2%, #fff0 30%);">
               <div class="main-content-page-topsection"></div>
                <div style="height: 100vh;display: flex;align-content: center;position: relative;flex-direction: column;">
                    <h1 style="color: white;margin: 16px;">Good day, see what's new...</h1>
                    <div class="home-genres-grid">
                        <div><img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0"><span>Nasm's things</span></div>
                        <div><img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0"><span>SussZ audios</span></div>
                        <div><img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0"><span>Unintelligable earrape</span></div>
                        <div><img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0"><span>Old time classics</span></div>
                        <div><img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0"><span>Master pieces</span></div>
                        <div><img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0"><span>RSS productions</span></div>
                     </div>                     
                     <a style="color: white;margin: 16px;font-size: 20;font-weight: bold;position: relative;">Recent listens<span style="position: absolute;right: 32px;top: 50%;transform: translateY(-50%);opacity: 0.6;">SEE MORE</span></a>
                    <div id="homeRecentCards" class="home-cards-grid">
                        <div><img src="https://comnplayscience.eu/app/images/notfound.png">Keskiiviko</div>
                        <div><img src="https://comnplayscience.eu/app/images/notfound.png">Vittu mikko</div>
                        <div><img src="https://comnplayscience.eu/app/images/notfound.png">The long master piece</div>
                        <div><img src="https://comnplayscience.eu/app/images/notfound.png">Cool adaptation no copyright</div>
                        <div><img src="https://comnplayscience.eu/app/images/notfound.png">Ode to BOY</div>
                     </div>                     
                    <a style="color: white;margin: 16px;font-size: 20;font-weight: bold;">Sound purgatory</a>
                </div>
            </div> 
            <!--Search page, only visible when current anchor is #search-->
            <div id="search" class="main-content-page" style="height: 5vh;">
                <div class="main-content-page-topsection" style="flex-direction: row;">
                    <div style="flex-grow: 1;"></div>
                    <div style="margin: 8px;">
                        <svg role="img" height="24" width="24" class="Svg-ytk21e-0 jAKAlG mOLTJ2mxkzHJj6Y9_na_" aria-hidden="true" viewBox="0 0 24 24" style="position: absolute;transform: translateY(-50%) translateX(5px);opacity: 0.6;top: 50%;"><path d="M10.533 1.279c-5.18 0-9.407 4.14-9.407 9.279s4.226 9.279 9.407 9.279c2.234 0 4.29-.77 5.907-2.058l4.353 4.353a1 1 0 101.414-1.414l-4.344-4.344a9.157 9.157 0 002.077-5.816c0-5.14-4.226-9.28-9.407-9.28zm-7.407 9.279c0-4.006 3.302-7.28 7.407-7.28s7.407 3.274 7.407 7.28-3.302 7.279-7.407 7.279-7.407-3.273-7.407-7.28z"></path></svg>
                        <input type="text" placeholder="Search">
                    </div>
                    <div style="flex-grow: 6;"></div>
                </div>
            </div> 
            <!--Lyrics page-->
            <div id="lyrics" class="main-content-page" style="background: linear-gradient(#624b4b, pink);">
                <canvas id="lyricsCanvas"></canvas>
                <div class="main-content-page-topsection" style="flex-direction: row;backdrop-filter: blur(16px) contrast(1.05) saturate(1.2);padding: 8px;margin-bottom: 32px;">
                   <h2 style=" color: white; margin: 8px;align-self: center;">Filthy French</h2>
                   <div style="width: 1px;background-color: gray;opacity: 0.6;"></div>
                   <h2 style=" color: white; margin: 8px;align-self: center;">SussZ</h2>
                </div>
                <div id="lyricsLines">
                    <!--Nothing is playing yet, head to your library to find a tune!-->
                </div>
                <div style="width: 20%;position: fixed;left: 80%;opacity: 0.6;">
                   <img src="Resources/SoundsLogo.png"><img>
                </div>
            </div>                         
            <!--Liked page, only visible when current anchor is #liked-->
            <div id="liked" class="main-content-page" style="background: linear-gradient(#5038a0 4%, #fff0 30%);">
               <div class="main-content-page-topsection"></div>
               <div style="height: 30vh;display: flex;align-content: center;position: relative; overflow: hidden;">
                  <img aria-hidden="false" draggable="false" loading="eager" src="https://t.scdn.co/images/3099b3803ad9496896c43f22fe9be8c4.png" alt="Liked Songs" srcset="https://t.scdn.co/images/3099b3803ad9496896c43f22fe9be8c4.png 150w, https://t.scdn.co/images/3099b3803ad9496896c43f22fe9be8c4.png 300w" style="margin: 16px;"> <span style="font-size: 96px; color: white;line-height: 30vh;font-weight: bold;user-select: none;">Liked Songs</span>
               </div>
               <div style="backdrop-filter: blur(15px) contrast(1.05) saturate(1.6);height: 800px;border-radius: 16px;padding: 24px;color: white;">
                    <div style="display: flex;width: 100%;flex-direction: row;">
                        <span style="flex: 1;">TITLE</span>
                        <span style="flex: 1;">ALBUM</span>
                        <span style="flex: 1;">DATE ADDED</span>
                        <svg role="img" height="16" width="16" viewBox="0 0 16 16" class="Svg-ytk21e-0 jAKAlG" style="fill: white;opacity: 0.6;flex: .2;"><path d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8z"></path><path d="M8 3.25a.75.75 0 01.75.75v3.25H11a.75.75 0 010 1.5H7.25V4A.75.75 0 018 3.25z"></path></svg>
                    </div>
                    <hr style="opacity: 0.6;">
                </div>
            </div>
         </div>         
    </div>
    <div id="playerBar">
        <div style="display: flex;flex: 1;">
            <img src="https://i.scdn.co/image/ab67616d00004851472fbc1d5743c7d3c75b9ec0" draggable="false" style="height: calc(100% - 16px);padding: 8px;display: inline;">
            <div style="align-self: top;">
                <p style="padding: 2px;line-height: 0px;color: white;">Song Name</p>
                <p style="padding: 2px;line-height: 0px;color: white;">Song Artist</p>
            </div>
        </div>
        <div style="position: relative;width: 100%;align-self: center;flex-grow: 1;height: 100%;flex: 3;">
            <div style="position: absolute;left: 50%;top: 40%;display: flex;flex-direction: row;align-items: center;justify-content: center;transform: translateX(-50%) translateY(-50%); column-gap: 12px;">
                <div>
                    <svg role="img" height="16" width="16" viewBox="0 0 16 16" style="fill: white; opacity: 0.6;"><path d="M3.3 1a.7.7 0 01.7.7v5.15l9.95-5.744a.7.7 0 011.05.606v12.575a.7.7 0 01-1.05.607L4 9.149V14.3a.7.7 0 01-.7.7H1.7a.7.7 0 01-.7-.7V1.7a.7.7 0 01.7-.7h1.6z"></path></svg>
                </div>
                <div id="playButton">
                    <svg role="img" height="16" width="16" viewBox="0 0 16 16" style="align-self: center; fill: #303030;"><path d="M3 1.713a.7.7 0 011.05-.607l10.89 6.288a.7.7 0 010 1.212L4.05 14.894A.7.7 0 013 14.288V1.713z"></path></svg>
                </div>
                <div>
                    <svg role="img" height="16" width="16" viewBox="0 0 16 16" style="fill: white; opacity: 0.6;"><path d="M12.7 1a.7.7 0 00-.7.7v5.15L2.05 1.107A.7.7 0 001 1.712v12.575a.7.7 0 001.05.607L12 9.149V14.3a.7.7 0 00.7.7h1.6a.7.7 0 00.7-.7V1.7a.7.7 0 00-.7-.7h-1.6z"></path></svg>
                </div>
            </div>
            <input type="range" id="progressBar">
        </div>
        <div style="flex: 0.4;display: flex;flex-direction: row;column-gap: 16px;"></div> <!--Hacky - find a real way to prefer align this to the left-->
        <div style="flex: 0.6;display: flex;flex-direction: row;column-gap: 16px;">
            <a href="#lyrics" style="align-self: center;"> <!--keroke button-->
                <svg color="white" role="img" height="16" width="16" viewBox="0 0 16 16" style="fill: white;opacity: 0.6;"><path d="M13.426 2.574a2.831 2.831 0 00-4.797 1.55l3.247 3.247a2.831 2.831 0 001.55-4.797zM10.5 8.118l-2.619-2.62A63303.13 63303.13 0 004.74 9.075L2.065 12.12a1.287 1.287 0 001.816 1.816l3.06-2.688 3.56-3.129zM7.12 4.094a4.331 4.331 0 114.786 4.786l-3.974 3.493-3.06 2.689a2.787 2.787 0 01-3.933-3.933l2.676-3.045 3.505-3.99z"></path></svg>
            </a>
            <a href="#queue" style="align-self: center;">
                <svg role="img" height="16" width="16" viewBox="0 0 16 16" style="fill: white;opacity: 0.6;"><path d="M15 15H1v-1.5h14V15zm0-4.5H1V9h14v1.5zm-14-7A2.5 2.5 0 013.5 1h9a2.5 2.5 0 010 5h-9A2.5 2.5 0 011 3.5zm2.5-1a1 1 0 000 2h9a1 1 0 100-2h-9z"></path></svg>
            </a>
            <div style="flex: 1;align-self: center;">
              <svg role="presentation" height="16" width="16" aria-label="Volume high" id="volume-icon" viewBox="0 0 16 16" style="fill: white;opacity: 0.6;"><path d="M9.741.85a.75.75 0 01.375.65v13a.75.75 0 01-1.125.65l-6.925-4a3.642 3.642 0 01-1.33-4.967 3.639 3.639 0 011.33-1.332l6.925-4a.75.75 0 01.75 0zm-6.924 5.3a2.139 2.139 0 000 3.7l5.8 3.35V2.8l-5.8 3.35zm8.683 4.29V5.56a2.75 2.75 0 010 4.88z"></path><path d="M11.5 13.614a5.752 5.752 0 000-11.228v1.55a4.252 4.252 0 010 8.127v1.55z"></path></svg>
              <input id="volumeSlider" type="range" style="width: calc(100% - 30px);transform: translateY(-4px);">
            </div>
        </div>
    </div>
</body>
<script>
    const clientPackets = {
        SyncHost: 0,
        SyncZombie: 1,
        UnsyncZombie: 2,
        Play: 3,
        Time: 4,
        Lyrics: 5,
        Search: 6,
        Purgatory: 7,
        Approve: 8,
        Veto: 9,
        SearchRandom: 10,
        SongInfo: 11
    }

    const serverPackets = {
        StartPlay: 0,
        EndPlay: 1,
        SetInfo: 2,
        SetTime: 3,
        RetPurgatory: 4,
        RetRandom: 5,
        RetLyrics: 6
    }

    const ctx = lyricsCanvas.getContext("2d")

    //Card grids, such as those inheriting home-cards-grid css class
    const cardGrids = [homeRecentCards]
    const socket = new WebSocket("wss://server.poemanthology.org:80")

    //This gives us the seconds from a subliminal (max hour mins seconds) lyric time 
    let lyricTimeToSecs = lyTime => 
        lyTime.split(":",3) //1. split by ':'                       
        .map(lyTime => Number(lyTime)) //2. convert items to nunbers ("" converts to 0)
        .reduce((total, current) => total * 60 + current, 0) //3. starting left, read number, add to total * 60

    function lyricFileToElements(lyrics) {
        let lines = lyrics.split("\n"), elements = [], elementsF = []

        for (let i = 0; i < lines.length; i++) {
            let line = lines[i]

            //Skip all blank or comment lines
            if (!line.trim() || line[0] == "#") continue

            //Get the milliseconds from the time stamp at the start of the lyric
            let milliseconds = lyricTimeToSecs(line.split(" ")[0]) * 1000

            let el = document.createElement("span")
            let formatted = line.substring(line.indexOf(" ") + 1)
            //TBC: test if str.split(' ').slice(1).join(' ') faster

            el.setAttribute("time", milliseconds)
            el.setAttribute("status", "later")

            //specific patches for line types
            switch (formatted[0]) {
                //lyric line is an addition
                case "+":
                    el.setAttribute("mode", "addition")
                    formatted = formatted.replace("+", "")
                    break
                //lyric line is a graphic
                case "!":
                    el.setAttribute("mode", "graphic")
                    formatted = formatted.replace("!", "")
                    break
                //lyric line mode is a normal line, but it starts with a special character that must be escaped
                case "\\":
                    formatted = formatted.replace("\\", "")
                    if (i != 0) elements.push(document.createElement("br"))
                    break
                default:
                    if (i != 0) elements.push(document.createElement("br"))
                    break
            }

            el.innerText = formatted
            elements.push(el)
        }

        return elements
    }


    function resizeLyricsCanvas() {
        lyricsCanvas.width = lyricsCanvas.offsetWidth
        lyricsCanvas.height = lyricsCanvas.offsetHeight
    }

    function renderCanvasEffect() {
        //Disco ball effect
        let time = 0
        let particles = []
        let sphere = {
            centreX: 600,
            centreY: 600,
            radius: 200
        }

        let renderTick = () => {
            ctx.clearRect(0, 0, lyricsCanvas.width, lyricsCanvas.height)
            let tick = time / 100

            for (let i = 0; i < particles.length; i++) {
                let circle = new Path2D()

                //Find the x offset (radius) of the current ring of tye sphere that this point is on
                let r = Math.acos(particles[i].offsetY / (sphere.radius * 2)) / Math.PI
                let ringRadius = Math.abs((sphere.radius * 2) * Math.sin(Math.PI * r))
                
                //Combine the initial radius, radius of ring particle is on (inverse distance from camera), and it's current X (pos in 3D) to get final radius
                let radius = (Math.sin(tick + particles[i].tickOffsetX) + 1) * particles[i].initialRadius * ringRadius
                
                circle.arc(
                    sphere.centreX + ringRadius * Math.cos(tick + particles[i].tickOffsetX), //X
                    particles[i].offsetY + sphere.centreY, //Y //sphere.offsetY + sphere.radius * (Math.cos(particles[i].initialY) + 1)
                    radius,//radius,
                    0, //Drawing stuff
                    2 * Math.PI, //Drawing stuff
                    false //Drawing stuff
                )
                ctx.fillStyle = particles[i].colour
                ctx.fill(circle)
            }

            time++
        }

        for (let y = -400; y < 400; y += 10) { //used for positioning
            for (let x = 0; x < 10; x++) { //used for populating
                particles.push({
                    colour: ['white', 'gray', 'lightgray'][Math.floor(Math.random() * 3)],
                    offsetY: y,
                    tickOffsetX: Math.random() * 1000,
                    initialRadius: .05
                })
            }
        }

        setInterval(renderTick, 16)
        //Snow effect

        //Big word effect

    }

    function resizeCardGrids() {
        for (let elementRef of cardGrids) {
            //A card should have a 3H : 2W ratio, with max width preferably being around 200px, on portrait, 100px, the maximum column count should be around 5mon
            let columnCount = Math.min(Math.floor(elementRef.offsetWidth / (window.innerHeight > window.innerWidth ? 100 : 200)), elementRef.childElementCount)
            let rowCount = Math.ceil(elementRef.childElementCount / columnCount)
            let height = 1.5 * elementRef.children[0].offsetWidth //non mathematical slightly dirty hack // 3 / 2, keeps 3:2 ratio
            elementRef.style.gridTemplateColumns = `repeat(${columnCount}, minmax(0px, 1fr))`
            elementRef.style.gridTemplateRows = `repeat(${rowCount}, ${height}px)`
            //let gridGap = (elementRef.offsetWidth - (elementRef.children[0].offsetWidth * columnCount)) / (columnCount + 1)
            //elementRef.style.columnGap = gridGap + "px"
        }      
    }


    async function testLyricLoad() {
        let example = await (await fetch("Resources/example.lyric")).text()
        for (let el of lyricFileToElements(example)) {
            lyricsLines.appendChild(el)
        }
    }

    resizeLyricsCanvas()
    renderCanvasEffect()

    addEventListener("resize", resizeLyricsCanvas, false)
    //addEventListener("resize", resizeCardGrids, false)
    //addEventListener("orientationchange", resizeCardGrids, false)

    /*setTimeout(() => {
        testLyricLoad()
        resizeCardGrids()
    }, 1000)*/
</script>
</html>
