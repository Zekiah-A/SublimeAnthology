<!DOCTYPE html>
<html>
<head>
  <title>Subliminal</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="../../styles.css">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>
 
<body style="background: initial;">
    <div class="title-blur">
        <h2 class="centre content" id="poemTitle"></h2>
        <hr>
    </div>
    <div id="poemMain" class="poem-centre">
        <p id="poemContent"></p>
    </div>
    <a id="back" href="./contents" class="back"> <- Back</a>
    <a id="edit" href="javascript: window.location.href = '../../poem-editor?edit=' + window.location.pathname + ',version=2'" class="edit"><svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" viewBox="0 0 48 48"><path d="M9 39h2.2l22.15-22.15-2.2-2.2L9 36.8Zm30.7-24.3-6.4-6.4 2.1-2.1q.85-.85 2.1-.85t2.1.85l2.2 2.2q.85.85.85 2.1t-.85 2.1Zm-2.1 2.1L12.4 42H6v-6.4l25.2-25.2Zm-5.35-1.05-1.1-1.1 2.2 2.2Z"></path></svg></a>
</body>
<script>
    let stringToHtml = text => {
      let htmlObject = document.createElement('temp')
      htmlObject.innerHTML = text
      return htmlObject.firstElementChild
    }

    async function initialise() {
        const params = new URLSearchParams(document.location.search)
        const path = params.get("path")
        const poemData = await (await fetch(window.location.protocol + "\/\/" + window.location.hostname + path + ".json")).json()
        
        if (poemData.cWarning === true) {
            let cWarningHtml = stringToHtml(await (await fetch("./Other/content-warning-template.html")).text())
            //split into chunks of max length 55, full cw line is 59 (pipe space, space pipe) + \n
            if (poemData.cWarningAdditions) {
                let chunks = poemData.cWarningAdditions.match(/.{1,55}/g), cwInsert = ""
                for (let chunk of chunks) {
                    chunk = chunk.padEnd(55) //if not taking up a whole line (is 55 chars long), pad spaces to line up
                    chunk = "| ".concat(chunk) //add pipe start
                    chunk = chunk.concat(" |") //add pipe end
                    cwInsert = cwInsert.concat("\n", chunk) //Add \n followed by chunk to end of cwinsert
                }
            }
            cWarningHtml.getElementsByTagName("pre").innerText = cWarningHtml.getElementsByTagName("pre").innerText.replace("ADDITIONAL_NOTES", cwInsert)
            document.body.insertBefore(cWarningHtml, back)
        }

        //Set up title and url bar for vanity
        window.history.replaceState(null, "Title", path)
        document.title = "Subliminal - " + poemData.poemName

        //Place poem data into the DOM
        poemTitle.innerText = poemData.poemName + " - By " + poemData.poemAuthor
        poemContent.innerHTML = poemData.poemContent
        poemMain.class = poemData.pageStyle
        document.body.style.background = poemData.pageBackground

        //Probably useless since pages are procedurally generated though...
        document.querySelector('meta[name="description"]').setAttribute("content", poemData.summary)
        document.querySelector('meta[name="keywords"]').setAttribute("content", poemData.tags)
    }
    
    initialise()
</script>
</html>
