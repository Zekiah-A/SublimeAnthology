<!DOCTYPE html>
<html>

<head>
   <title>Subliminal</title>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="./styles.css">
   <style>
		.profile-top {
			text-align:center;
			border-radius:8px;
			display:flex;
			column-gap:8px;
			margin-top:16px;
			margin-bottom:16px;
		}
		.profile-top > h1 {
			flex-grow:1;
			margin:0;
			font-family:Arial,Helvetica,sans-serif;
		}

		.profile-title {
			font-family:Arial,Helvetica,sans-serif;
			font-size:42px;
			margin-top:0;
			margin-bottom:0;
			white-space:pre;
			display: inline;
		}

		.poem-card {
			width:calc(100% - 32px);
			height:64px;
			background:var(--button-opaque);
			border-radius:8px;
			display: flex;
			flex-direction: row;
			column-gap: 16px;
			padding: 4px;
			padding-left: 16px;
			padding-right: 16px;
		}
		.poem-card .poem-preview {
			position: relative;
			margin: 0px;
			padding: 8px;
			overflow: hidden;
		}
		.poem-card .poem-preview::after {
			opacity: 1;
			width: 100%;
			height: 100%;
			top: 0;
			left: 0;
			position: absolute;
			background: linear-gradient(var(--button-opaque), transparent, var(--button-opaque));
			content: '';
			display: inline;			
		}

		.profile-badge {
			background: linear-gradient(white, #f9f3f3);
			width: 32px;
			height: 32px;
			display: block;
			border-radius: 100%;
			border: 1px solid grey;
			text-align: center;
			line-height: 32px;
		}

		.role-grid {
			display: grid;
			grid-template-columns: auto auto auto;
			grid-gap: 8px;
		}

		#profileImage {
			border-radius:4px;
			cursor: pointer;
		}

		#recentWorks {
			display: flex;
			flex-direction: column;
			row-gap: 16px;
		}

		#profileBadges {
			width: 100%;
			height: 32px;
			margin: 8px;
			display: flex;
			column-gap: 8px;
		}
   </style>
</head>

<body>
	<div id="profileRole" style="height: fit-content; width: 40%; display: none;" class="popup">
		<h2>Your profile role:</h2>
		<div class="role-grid">
			<div class="popup-button" onclick="setProfileRole('writer');">Writer</div>
			<div class="popup-button" onclick="setProfileRole('reader');">Reader</div>
			<div class="popup-button" onclick="setProfileRole('listener');">Listener</div>
			<div class="popup-button" onclick="setProfileRole('poet');">Poet</div>
			<div class="popup-button" onclick="setProfileRole('critic');">Critic</div>
			<div class="popup-button" onclick="setProfileRole('reviewer');">Reviewer</div>
			<div class="popup-button" onclick="setProfileRole('analyser');">Analyser</div>
			<div class="popup-button" onclick="setProfileRole('teacher');">Teacher</div>
			<div class="popup-button" onclick="setProfileRole('student');">Student</div>
			<div class="popup-button" onclick="setProfileRole('hobbyist');">Hobbyist</div>
			<div class="popup-button" onclick="setProfileRole('casual');">Casual</div>
		</div>
		<br>
		<input type="text" placeholder="Write your own!" maxlength="8" style="width:calc(100% - 8px);display:block;line-height:200%" oninput="setProfileRole(value)">
		<br>
		<div class="popup-button" onclick="profileRole.style.display = 'none'; updateProfile()">Done</div>
		<p style="opacity: 0.6;">These are for vanity purposes only, setting a certain role won't limit you from doing certain actions!</p>
	</div>
	<div id="profileAvatarUrl" style="height: fit-content; width: 40%; display: none;" class="popup"> <!--display: none;-->
		<h2>Set profile image</h2>
		<p>Enter image link:</p>
		<input id="profileAvatarInput" type="text" placeholder="https://public.keskofiles.com/f/k-ruoka/product/7350126081371" style="width:calc(100% - 8px);display:block;line-height:200%">
		<br>
		<div class="popup-button" onclick="profileAvatarUrl.style.display = 'none'; setProfileAvatar(profileAvatarInput.value); updateProfile()">Done</div>
	</div>
	<div class="div-centre">
		<h1>Account</h1>
		<!--
		<div style="text-align:center;border-radius:8px;display:flex;column-gap:8px;margin-top:16px;margin-bottom:16px;width:150%;transform:translateX(-13.5%);">
			<div id="profileBadges" style="font-size:24px">üìõ</div>
			<div id="profileJoinDate" style="font-size:24px">21/10/2022</div>
			<h1 style="flex-grow:1;margin:0;font-family:Arial,Helvetica,sans-serif" contenteditable="true">Lord Zekiah<br></h1>
		</div>
		-->
		<div style="display:flex;column-gap:16px">
			<img id="profileAvatar" src="https://user-images.githubusercontent.com/11250/39013954-f5091c3a-43e6-11e8-9cac-37cf8e8c8e4e.jpg" width="200" height="200" onclick="profileAvatarUrl.style.display='block';">
			<div style="flex-direction:column">
				<p class="profile-title">I'm </p><p class="profile-title" id="profileName" contenteditable="true" onblur="updateProfile()" onkeydown="if (this.textContent.length >= 16) this.textContent = this.textContent.substring(0, 16);">Nameless</p><p class="profile-title" id="profileRoleText" style="cursor: pointer;" onmouseover="this.style.textDecoration = 'underline'" onmouseleave="this.style.textDecoration = 'none';" onclick="profileRole.style.display = 'block';">, a writer</p>
				<p style="width: 442px; line-break: anywhere;" contenteditable="true" id="profileBiography" onkeydown="if (this.textContent.length >= 360) this.textContent = this.textContent.substring(0, 360);">Click here to start writing your bio!</p>
				<div style="display:flex;column-gap:16px;flex-direction:column;margin-top:8px">
					<div>üåç&nbsp;<span contenteditable="true" id="profileLocation" onblur="updateProfile()">Planet of Earth, Milky Way</span></div>
					<div>üìå&nbsp;<span contenteditable="true" id="profilePinned" onblur="updateProfile()">Poem1, Poem2, Poem3, Poem4, Poem5</span></div>
				</div>
				<div id="profileBadges"></div>
			</div>
		</div>
		<br>
		<h2>Recent works:</h2>
		<div id="recentWorks">
			<div class="poem-card">
				<h4>London</h4>
				<p class="poem-preview">I walk through each chartered street, near where the chartered thames do flow. And marks on every face I meet, marks of weakness, marks of woe.</p>
			</div>
		</div>
		<br><br><br><br><br> <!--TEMP-->
		<h2>Private account info:</h2>
		<hr>
		<p>This stuff won't appear on your profile, it is for your eyes only!</p>
		<h2>Draft poems:</h2>
		<div id="draftPoems">
			<div class="poem-card">
				<h4>London</h4>
				<p class="poem-preview">I walk through each chartered street, near where the chartered thames do flow. And marks on every face I meet, marks of weakness, marks of woe.</p>
			</div>
		</div>
		<br><br><br><br><br> <!--TEMP-->
		<hr>
		<h1>Account agreement:</h1>
		<h2>Privacy &amp; Security:</h2>
		<p>While other things on this site may be, account security is no joke here, this site has no tracking, external
			cookies, etc, and never will, and the same principle goes for accounts, we will NEVER ever sell, share, or
			process ANYTHING related to personal information/accounts. Every non-public account detail is sha256 encrypted
			using your account code, with your account code being encrypted too! This means that it is impossible for us,
			or anyone else to ever acess any account detail without your account code, which can not be exfiltrated from
			our servers due to itself being encrypted, however, it also means that your account code is very important for
			security. If you think you have lost it, or someone else has gained access to it, please report here.
		</p>
		<h2>Law and Regulations:</h2>
		<p>This site aims to be a place for freedom of expresion through the medium of poetry. While we can not claim
			responsibility for if you fall under punishment, penilisation, or persecution by an institution, government, or
			other individual as a result of a work submitted here, we will always try to protect you whenever we can. This
			means, never allowing your personal info to be shared with anyone but you, ensuring that minimal information
			can be shared in the case of a sipoena, and allowing you to remove any data you have uploaded here on request.
		</p>
		<p>If you use this site, with the explicit purpose to publicly post illegal, or plain morally objectable content,
			your account may be removed, or IP blocked from submitting content to the site. It is both impossible, and
			against our values to use any of your personal information against you, but, if you publicly post something
			such as your location in a work you upload, others can, and may forward this on to relevant authorities. If you
			post something publicly, people can see use it.
		</p>
		<h2>Being subliminal:</h2>
		<p>The final thing we'd like to note, is that this is a cool place. This site is supposed to be fun, experimental,
			a bit wacky, so feel free to join in with our community, commenting, annotating, rating, or submitting your own
			poems, no matter what you do here, if it is making subliminal a better place, we are all for it!
		</p>
	</div>
	<a href="./contents" class="back"> &lt;- Back</a>
</body>
<script>
	let role = ""
	let avatarUrl = ""
	let data = {}

	const badgeType = {
		Admin: 0,
    	Based: 1,
    	WellKnown: 2,
    	Verified: 3,
    	Original: 4,
    	New: 5
	}

	let stringToHtml = text => {
      let htmlObject = document.createElement('temp')
      htmlObject.innerHTML = text
      return htmlObject.firstElementChild
    }

	function setProfileAvatar(newUrl) {
		if (newUrl == null) return

		avatarUrl = newUrl
		profileAvatar.src = avatarUrl
	}

	function setProfileRole(newRole) {
		if (newRole == null) return

		role = role.substring(0, 8)
		role = newRole
		profileRoleText.textContent = (["a", "e", "i", "o", "u"].indexOf(role[0].toLowerCase()) !== -1 ? ", an " : ", a ") + role
	}

	async function setProfileBadges(newBadges) {
		if (newBadges == null) return
		
		for (let badge of newBadges) {
			let badgeName = Object.keys(badgeType).find(key => badgeType[badge] === badge)

			let badgeElement = document.createElement("div")
			badgeElement.className = "profile-badge"

			let tooltip = document.createElement("div")
			tooltip.className = "button-tooltip"
			tooltip.textContent = getBadgeInfo(badge)
			badgeElement.appendChild(tooltip)

			let icon = stringToHtml(await (await fetch("./Resources/" + badgeName + "Badge.svg")).text())
			icon.setAttribute("viewBox", "0 0 64 64")
			icon.setAttribute("width", "32")
			icon.setAttribute("height", "32")
			badgeElement.appendChild(icon)

			profileBadges.appendChild(badgeElement)
		}
	}

	function getBadgeInfo(badge) {
		switch (badge) {
			case badgeType.Admin:
				return "This person has the special role of ensuring things don't get too out of hand! Admins keep subliminal as the #1 spot for poems."
			case badgeType.Based:
				return "This person skirts the edge, either by pushing the limits of content here, or exploring places in creativity that others may fear to follow."
			case badgeType.New:
				return "This person recently made an account on subliminal, say hello!"
			case badgeType.Verified:
				return "This person has been verified to be who they claim they are (no imposters here)!"
			case badgeType.WellKnown:
				return "This person is certainly known for something, and is well established here because of it!"
		}
	}

	async function updateProfile() {
		data.profile.penName = profileName.textContent || data.profile.penName
		data.profile.biography = profileBiography.textContent || data.profile.biography
		data.profile.location = profileLocation.textContent || data.profile.location
		data.profile.role = role || data.profile.role
		data.profile.pinnedPoems = profilePinned.textContent.split(", ") || []
		data.profile.avatarUrl = avatarUrl || data.profile.avatarUrl

		fetch('https://server.poemanthology.org:81/UpdateAccountProfile', {
			method: "POST",
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ code: localStorage.accountCode, profile: data.profile })
		})
		.then((res) => {
			console.log(res)
		})
	}

	async function initialise() {
		if (!localStorage.accountCode || !localStorage.accountGuid) {
			alert("You don't seem to have an account here, so this page won't be of much use ;(\n Head over to the contents page to create one.")
			return
		}

		fetch('https://server.poemanthology.org:81/Signin', {
			method: "POST",
			headers: { 'Content-Type': 'application/json' },
			body: '"' + localStorage.accountCode + '"'
		})
		.then((signinResponse) => signinResponse.json())
		.then((signinData) => {
			let signinObject = JSON.parse(signinData)
			profileName.textContent = signinObject.profile?.penName || "Nameless"
			profileBiography.textContent = signinObject.profile?.biography || "Click here to start writing your bio!"
			profileLocation.textContent = signinObject.profile?.location || "Planet Earth, Milky Way"
			profilePinned.textContent = (signinObject.profile?.pinnedPoems?.length > 0 ? signinObject.profile?.pinnedPoems : "Nothing pinned yet.") || "Nothing pinned yet."
			setProfileRole(signinObject.profile?.role || "writer")
			setProfileAvatar(signinObject.profile?.avatarUrl || "https://user-images.githubusercontent.com/11250/39013954-f5091c3a-43e6-11e8-9cac-37cf8e8c8e4e.jpg")
			data = signinObject
		})
	}

	initialise()
</script>
</html>
