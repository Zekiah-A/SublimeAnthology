<!DOCTYPE html>
<html>
<head>
  <title>Subliminal - NAME</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="./styles.css">
  <meta name="description" content="A poem awaiting judgement, located in the forsaken subliminal poem purgatory...">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    .rating-container {
        user-select: none;
        display: flex;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        row-gap: 8px;
        flex-direction: column;
        padding: 32px;
        padding-top: 16px;
    }

    .rating-container > div {
        display: flex;
        column-gap: 8px;
    }

    .rate-button {
        background-color: var(--button-opaque);
        border-radius: 4px;
        text-align: center;
        line-height: 48px;
        height: 48px;
        flex: 1 1 0px;
    }
  </style>
</head>
 
<body>
    <div class="title-blur">
        <div style="display: flex;">
            <h2 id="poemTitle" style="display: inline; flex-grow: 1; text-align: end; margin-bottom: 12px;">TITLE</h2>
            <h2 style="display: inline; margin-bottom: 12px; white-space: pre;"> - By </h2>
            <h2 id="poemAuthor" style="display: inline; flex-grow: 1; text-align: start; margin-bottom: 12px;">AUTHOR</h2>
        </div>
        <hr>
    </div>
    <div id="poemMain">
        <p id="poemContent">
            CONTENT
        </p>
        <p id="amendmentNote" style="opacity: 0.2; display: none;">This poem is an amendment of another poem. <a id="amendmentLink" href="#" style="font-size: 100%;">See the original here.</a></p>
        <div class="rating-container">
            <div>
                <a href="#contentWarning" onclick="ratePoem(/*localStorage.approved.has(guid) ? ratingType.UndoApprove : */ratingType.Approve)" class="rate-button">Approve</a>
                <a href="#contentWarning" onclick="ratePoem(/*localStorage.vetoed.has(guid) ? ratingType.UndoVeto : */ratingType.Veto)" class="rate-button">Veto</a>
            </div>
            <a href="#" style="color: #ff0606; text-align: center;">⚠ Report poem content</a>
        </div>
    </div>
    <div id="editFrame" style="height: auto; width: 30%; display: none;" class="popup">
        <h2>Poem editor:</h2>
        <div style="display: flex; column-gap: 8px;">
            <div class="popup-button" style="height: 128px;" onclick="window.location.href = './poem-editor?amend=' + guid;">
                <div style="display: flex; flex-direction: column; align-items: center;"><img src="./Resources/AmendMode.png" style="display: block;" height="112" width="112">Amend original poem</div>
            </div>
            <div class="popup-button" style="height: 128px;" onclick="window.location.href = './poem-editor?edit=' + guid;">
                <div style="display: flex; flex-direction: column; align-items: center;"><img src="./Resources/InspiredMode.png" style="display: block;" height="112" width="112">New Inspired poem</div>
            </div>
        </div>
        <br>
        <div class="popup-button" onclick="editFrame.style.display = 'none';">Cancel</div>
    </div>
    <div id="profileFrame" style="height: 512px; width: 60%; display: none;" class="popup">
        <iframe id="profileIframe" src="" style="width: 100%; height: calc(100% - 42px);" frameborder="0"></iframe>
        <div class="popup-button" onclick="profileFrame.style.display = 'none';">Done</div>
	</div>

    <div id="contentWarning" style="display: none;">
        <pre class="warning-centre">
___________________________________________________________
| Disclaimer: This is a poem in the subliminal poem       |
| purgatory, created in the <a href="./poem-editor">poem editor</a>, and awaiting     |
| approval or rejection to be added to the site, we can't |
| confirm that the events within this poem are fictional, |
| and shouldn't be taken as moral, political, or religious|
| advice, or represents the beliefs of the author in any  |
| way.                                                    |
|                                                         |
| If this poem is unironically bad, not even a poem, or   |
| you just don't like it for any reason feel free to VETO |
| by pressing the VETO button at the bottom of the screen |
| likewise, if it's great, APPROVE it!                    |
|                                                         |
| If you are concerned as to if there is illegal content  |
| contained within this submission, please report via the |
| report button, and we will investigate ASAP.            |
|                                                         |
| <a class="continue" href="#contentWarning">Continue -></a>                                             |
| <a href="./disclaimer">See Disclaimer -></a>                                       |
|                                                         |
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
        </pre>
    </div>  
    <a href="../../contents" class="back"> <- Back</a>
    <div onclick="editFrame.style.display = 'block';" class="edit"><svg xmlns="http://www.w3.org/2000/svg" style="fill: var(--text-colour);" height="32" width="32" viewBox="0 0 48 48"><path d="M9 39h2.2l22.15-22.15-2.2-2.2L9 36.8Zm30.7-24.3-6.4-6.4 2.1-2.1q.85-.85 2.1-.85t2.1.85l2.2 2.2q.85.85.85 2.1t-.85 2.1Zm-2.1 2.1L12.4 42H6v-6.4l25.2-25.2Zm-5.35-1.05-1.1-1.1 2.2 2.2Z"></path></svg></div>
</body>
<script>
    const params = new URLSearchParams(document.location.search)
    const guid = params.get("guid")
    const ratingType = {
        Approve: 0,
        Veto: 1,
        UndoApprove: 2,
        UndoVeto: 3
    }

    function ratePoem(rating) {
        let ratingObject = {
            guid: guid.toString(),
            purgatoryRating: rating,
            code: localStorage.accountCode || null
        }
     
        fetch("https://server.poemanthology.org:81/PurgatoryRate", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ratingObject) + localStorage.accountCode ? "\"" + localStorage.accountCode + "\"": ""
        }).then(res => {
            alert('Rating success!')
            let ratingName = Object.keys(ratingType)
                .find(key => ratingType[key] === rating)

            /*switch(ratingName) {
                case "Approve": localStorage.approved.add(guid); break;
                case "Veto": localStorage.vetoed.add(guid); break;
                case "UndoApprove": localStorage.approved.delete(guid); break;
                case "UndoVeto": localStorage.vetoed.delete(guid); break;
            }*/
        })
    }

    async function initialise() {
        //init localstorage
        if (!localStorage.getItem('approved')) 
            localStorage.approved = new Set()
        if (!localStorage.getItem('vetoed'))
            localStorage.vetoed = new Set()

        //fetch poem data
        let poemData = await (await fetch("https://server.poemanthology.org:81/Purgatory/" + guid)).json()
        
        //Set up title for vanity
        document.title = "Subliminal - " + poemData.poemName

        //Place poem data into the DOM
        
        //If author has a GUID (account),link it to the poem
        if (poemData.authorGuid) {
            poemAuthor.setAttribute("onclick", "profileFrame.style.display = 'block';")
            poemAuthor.setAttribute("onmouseover", "this.style.textDecoration = 'underline';")
            poemAuthor.setAttribute("onmouseleave", "this.style.textDecoration = 'none';")
            poemAuthor.style.cursor = "pointer"
            profileIframe.src = "./Other/profile-template-frame.html?guid=" + poemData.authorGuid
        }
        
        //Set up title
        poemTitle.textContent = poemData.poemName
        poemAuthor.textContent = poemData.poemAuthor
        
        //Set up main poem content
        poemContent.innerHTML = poemData.poemContent
        poemMain.setAttribute("class", poemData.pageStyle) 
        document.body.style.background = poemData.pageBackground

        //If the poem is an adaptation/amendment of another, then keep track of that as well
        if (poemData.amends) {
            amendmentNote.style.display = "block"
            amendmentLink.href = window.location.protocol + '\/\/' + window.location.hostname + 
                (poemData.amends.includes("/") ? "/poem?path=" + poemData.amends : "purgatory-poem?guid=" + poemData.amends)
        }

        //Probably useless since pages are procedurally generated...
        document.querySelector('meta[name="description"]').setAttribute("content", poemData.summary)
        document.querySelector('meta[name="keywords"]').setAttribute("content", poemData.tags)
    }
    
    initialise()
</script>
</html>
