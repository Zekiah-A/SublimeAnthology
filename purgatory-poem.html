<!DOCTYPE html>
<html>
<head>
  <title>Subliminal - NAME</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="./styles.css">
  <meta name="description" content="A poem awaiting judgement, located in the forsaken subliminal poem purgatory...">
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    .rating-container {
        user-select: none;
        display: flex;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        row-gap: 8px;
        flex-direction: column;
        padding: 32px;
        padding-top: 16px;
    }

    .rating-container > div {
        display: flex;
        column-gap: 8px;
    }

    .rate-button {
        background-color: var(--button-opaque);
        border-radius: 4px;
        text-align: center;
        line-height: 48px;
        height: 48px;
        flex: 1 1 0px;
    }
  </style>
</head>

<!--<svg xmlns="http://www.w3.org/2000/svg" height="48" width="48"><path d="m16.15 37.75 7.85-4.7 7.85 4.75-2.1-8.9 6.9-6-9.1-.8L24 13.7l-3.55 8.35-9.1.8 6.9 6Zm7.85-1.2-9.3 5.6q-.4.25-.85.225-.45-.025-.8-.275-.35-.25-.525-.65-.175-.4-.075-.9l2.45-10.6-8.2-7.15q-.4-.35-.475-.775-.075-.425.025-.825.1-.4.45-.675t.85-.325l10.85-.95 4.2-10q.2-.45.6-.675.4-.225.8-.225t.8.225q.4.225.6.675l4.2 10 10.85.95q.5.05.85.325t.45.675q.1.4.025.825-.075.425-.475.775l-8.2 7.15 2.45 10.6q.1.5-.075.9t-.525.65q-.35.25-.8.275-.45.025-.85-.225Zm0-10.3Z"/></svg>-->
<body>
    <div class="title-blur">
        <div style="display: flex;">
            <h2 id="poemTitle" style="display: inline; flex-grow: 1; text-align: end; margin-bottom: 12px;">TITLE</h2>
            <h2 style="display: inline; margin-bottom: 12px; white-space: pre;"> - By </h2>
            <h2 id="poemAuthor" style="display: inline; flex-grow: 1; text-align: start; margin-bottom: 12px;">AUTHOR</h2>
        </div>
        <!--<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 2940 2940"><path d="m977 2-4 2c-5 0-16 9-48 42-26 26-38 40-40 46-4 10-4 12-3 17l2 8 1 6a301 301 0 0 1 11 36c2 8 3 13 5 16l1 5 2 6 1 9c0 5 0 6-10 14l-10 8-11 9-5 4a136 136 0 0 1-12 10l-5 4a2396 2396 0 0 0-96 79l-13 11a187 187 0 0 0-15 12 621 621 0 0 0-53 44l-20 16-5 4-10 8-11 9-6 5a187 187 0 0 1-19 16 229 229 0 0 1-14 11l-15 12a525 525 0 0 0-23 20l-11 8-11 9-6 5a187 187 0 0 1-19 16 229 229 0 0 1-13 10 234 234 0 0 1-22 18l-6 5-24 19c-6 5-8 6-12 4l-3-2-5-1-6-3-5-2-2-1-4-2-9-3-8-3-13-5-6-1-5-1-4-2-4-1-7-2-9-2a286 286 0 0 0-62-9c-11-1-21-1-34 1l-17 1-9 1-8 2-18 4-7 2-5 2-3 1-5 1-6 3c-13 6-20 10-32 18-17 11-34 26-38 33-3 5-5 14-5 20 0 10 3 16 10 25a9245 9245 0 0 0 266 268c1 2-12 15-102 106L16 1283c-15 14-16 16-16 27 0 21 10 33 30 39 11 4 19 1 34-13 15-13 36-33 204-201l153-151 99 98 173 171c10 7 21 9 33 6 11-3 16-6 26-19l6-7a264 264 0 0 0 33-58l1-4 2-5 2-6 4-19 2-9a353 353 0 0 0-27-188l-3-6-2-4-1-5-3-6c-2-4-2-8 0-10l6-7 10-13 8-10a349 349 0 0 0 22-27 754 754 0 0 1 27-33l21-25 6-7a667 667 0 0 1 18-22l4-6 5-6a823 823 0 0 1 36-44l9-11 4-5 5-6a288 288 0 0 1 22-27l7-8 9-11a1078 1078 0 0 0 22-27l6-7 12-14 9-11 4-6 5-6a768 768 0 0 1 39-47 1653 1653 0 0 1 53-64l14-18h6l10 2 6 1 5 2 6 1 5 2 5 1 4 1 5 2a98 98 0 0 1 17 5l9 2c5 2 15 3 22 3 5-1 8-1 12-4a426 426 0 0 0 87-91c3-6 1-13-5-21l-3-5-4-4-8-10c-14-16-45-48-151-153A6954 6954 0 0 0 996 4c-3 0-5-1-5-3l-6-1c-5 0-7 0-8 2zm142 229 135 134-11 10-10 10-4-1a385 385 0 0 0-33-10l-5-1-5-1-4-2-7-1a305 305 0 0 0-44-9l-9 4-29 30-9 11-15 18a300 300 0 0 1-22 25l-10 12-7 9a182 182 0 0 0-13 15l-10 12-8 9a153 153 0 0 0-15 19l-15 18-13 16-6 7-5 6a366 366 0 0 0-24 29l-16 20a187 187 0 0 1-12 14l-9 11-8 10-5 5a2484 2484 0 0 1-81 99 188 188 0 0 0-14 18l-8 10-5 6-6 6a517 517 0 0 1-22 29l-7 9-5 6a571 571 0 0 1-34 42c-11 15-14 24-11 31l2 5 2 6 3 7a409 409 0 0 0 14 34 141 141 0 0 0 6 15l2 5 1 3 2 5 1 4 2 5 1 5 2 5 1 5 2 5 1 6 2 7 1 8c4 9 3 69 0 85a107 107 0 0 1-7 24l-4 7c-1 0-524-522-524-524s16-7 31-11l16-2a474 474 0 0 0 35-2l20 2a155 155 0 0 1 35 6l8 2 6 2 6 2 5 2 5 1 4 2 5 1 5 1a273 273 0 0 1 49 22l15 5c7 2 8 2 12 1l6-2 15-10a238 238 0 0 1 15-12l6-5 8-7 7-6a1678 1678 0 0 0 37-29l11-9 10-8 5-5 7-5 22-18 5-4 10-8 11-9 7-6 16-13 14-12a322 322 0 0 1 26-21 2106 2106 0 0 0 86-72 807 807 0 0 0 56-46l63-52 21-18a15314 15314 0 0 0 57-48l10-9 8-7c4-4 5-6 5-11a76 76 0 0 0-3-29l-4-16-2-6-2-6-1-5-1-4-2-5-2-7-7-23c0-2 1-4 9-12l10-10c1 0 62 60 135 134z"/></svg>-->
        <!--<svg xmlns="http://www.w3.org/2000/svg" height="32" width="32" style="position: absolute;right: 16px;top: 50%;transform: translateY(-50%);opacity: 0.6;" viewBox="0 0 48 48"><path d="m16.15 37.75 7.85-4.7 7.85 4.75-2.1-8.9 6.9-6-9.1-.8L24 13.7l-3.55 8.35-9.1.8 6.9 6ZM11.65 44l3.25-14.05L4 20.5l14.4-1.25L24 6l5.6 13.25L44 20.5l-10.9 9.45L36.35 44 24 36.55ZM24 26.25Z"></path></svg>-->
        <hr>
    </div>
    <div id="poemMain">
        <p id="poemContent">
            CONTENT
        </p>
        <p id="amendmentNote" style="opacity: 0.2; display: none;">This poem is an amendment of another poem. <a id="amendmentLink" href="#" style="font-size: 100%;">See the original here.</a></p>
        <p id="editNote" style="opacity: 0.2; display: none;">This poem is an edited version of another poem. <a id="editLink" href="#" style="font-size: 100%;">See the original here.</a></p>
        <div class="rating-container">
            <div>
                <a href="#contentWarning" onclick="ratePoem(/*localStorage.approved.has(guid) ? ratingType.UndoApprove : */ratingType.Approve)" class="rate-button">Approve</a>
                <a href="#contentWarning" onclick="ratePoem(/*localStorage.vetoed.has(guid) ? ratingType.UndoVeto : */ratingType.Veto)" class="rate-button">Veto</a>
            </div>
            <a href="#" style="color: #ff0606; text-align: center;">⚠ Report poem content</a>
        </div>
    </div>
    <div id="editFrame" style="height: auto; width: 30%; display: none;" class="popup">
        <h2>Poem editor:</h2>
        <div style="display: flex; column-gap: 8px;">
            <div class="popup-button" style="height: 128px;" onclick="window.location.href = './poem-editor?amend=' + guid;">
                <div style="display: flex; flex-direction: column; align-items: center;"><img src="./Resources/AmendMode.png" style="display: block;" height="112" width="112">Amend original poem</div>
            </div>
            <div class="popup-button" style="height: 128px;" onclick="window.location.href = './poem-editor?edit=' + guid;">
                <div style="display: flex; flex-direction: column; align-items: center;"><img src="./Resources/InspiredMode.png" style="display: block;" height="112" width="112">New Inspired poem</div>
            </div>
        </div>
        <br>
        <div class="popup-button" onclick="editFrame.style.display = 'none';">Cancel</div>
    </div>
    <div id="profileFrame" style="height: 512px; width: 60%; display: none;" class="popup">
        <iframe id="profileIframe" src="" style="width: 100%; height: calc(100% - 42px);" frameborder="0"></iframe>
        <div class="popup-button" onclick="profileFrame.style.display = 'none';">Done</div>
	</div>

    <div id="contentWarning" style="display: none;">
        <pre class="warning-centre">
___________________________________________________________
| Disclaimer: This is a poem in the subliminal poem       |
| purgatory, created in the <a href="./poem-editor">poem editor</a>, and awaiting     |
| approval or rejection to be added to the site, we can't |
| confirm that the events within this poem are fictional, |
| and shouldn't be taken as moral, political, or religious|
| advice, or represents the beliefs of the author in any  |
| way.                                                    |
|                                                         |
| If this poem is unironically bad, not even a poem, or   |
| you just don't like it for any reason feel free to VETO |
| by pressing the VETO button at the bottom of the screen |
| likewise, if it's great, APPROVE it!                    |
|                                                         |
| If you are concerned as to if there is illegal content  |
| contained within this submission, please report via the |
| report button, and we will investigate ASAP.            |
|                                                         |
| <a class="continue" href="#contentWarning">Continue -></a>                                             |
| <a href="./disclaimer">See Disclaimer -></a>                                       |
|                                                         |
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
        </pre>
    </div>  
    <a href="../../contents" class="back"> <- Back</a>
    <div onclick="editFrame.style.display = 'block';" class="edit"><svg xmlns="http://www.w3.org/2000/svg" style="fill: var(--text-colour);" height="32" width="32" viewBox="0 0 48 48"><path d="M9 39h2.2l22.15-22.15-2.2-2.2L9 36.8Zm30.7-24.3-6.4-6.4 2.1-2.1q.85-.85 2.1-.85t2.1.85l2.2 2.2q.85.85.85 2.1t-.85 2.1Zm-2.1 2.1L12.4 42H6v-6.4l25.2-25.2Zm-5.35-1.05-1.1-1.1 2.2 2.2Z"></path></svg></div>
</body>
<script>
    const params = new URLSearchParams(document.location.search)
    const guid = params.get("guid")
    const ratingType = {
        Approve: 0,
        Veto: 1,
        UndoApprove: 2,
        UndoVeto: 3
    }

    function ratePoem(rating) {
        let ratingObject = {
            guid: guid.toString(),
            purgatoryRating: rating,
            code: localStorage.accountCode || null
        }
     
        fetch("https://server.poemanthology.org:81/PurgatoryRate", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ratingObject)
        }).then(res => {
            if (!res.ok) {
                console.error("Failed to rate poem " + res)
                alert("Failed to rate this poem, sorry! 😭\nMaybe try again...")
                return
            }
            alert('Rating success!')
            let ratingName = Object.keys(ratingType)
                .find(key => ratingType[key] === rating)

            /*switch(ratingName) {
                case "Approve": localStorage.approved.add(guid); break;
                case "Veto": localStorage.vetoed.add(guid); break;
                case "UndoApprove": localStorage.approved.delete(guid); break;
                case "UndoVeto": localStorage.vetoed.delete(guid); break;
            }*/
        })
    }

    async function initialise() {
        //init localstorage
        if (!localStorage.getItem('approved')) 
            localStorage.approved = new Set()
        if (!localStorage.getItem('vetoed'))
            localStorage.vetoed = new Set()

        //fetch poem data
        let poemData = await (await fetch("https://server.poemanthology.org:81/Purgatory/" + guid)).json()
        
        //Set up title for vanity
        document.title = "Subliminal - " + poemData.poemName

        //Place poem data into the DOM
        
        //If author has a GUID (account),link it to the poem
        if (poemData.authorGuid) {
            poemAuthor.setAttribute("onclick", "profileFrame.style.display = 'block';")
            poemAuthor.setAttribute("onmouseover", "this.style.textDecoration = 'underline';")
            poemAuthor.setAttribute("onmouseleave", "this.style.textDecoration = 'none';")
            poemAuthor.style.cursor = "pointer"
            profileIframe.src = "./Other/profile-template-frame.html?guid=" + poemData.authorGuid
        }
        
        //Set up title
        poemTitle.textContent = poemData.poemName
        poemAuthor.textContent = poemData.poemAuthor
        
        //Set up main poem content
        poemContent.innerHTML = poemData.poemContent
        poemMain.setAttribute("class", poemData.pageStyle) 
        document.body.style.background = poemData.pageBackground

        //If the poem is an adaptation/amendment, or an edited version of another, then keep track of that as well
        if (poemData.amends) {
            amendmentNote.style.display = "block"
            amendmentLink.href = window.location.protocol + '\/\/' + window.location.hostname + 
                (poemData.amends.includes("/") ? "/poem?path=" + poemData.amends : "purgatory-poem?guid=" + poemData.amends)
        }
        else if (poemData.edits) {
            editNote.style.display = "block"
            editLink.href = window.location.protocol + '\/\/' + window.location.hostname + 
                (poemData.edits.includes("/") ? "/poem?path=" + poemData.edits : "purgatory-poem?guid=" + poemData.edits)
        }

        //Probably useless since pages are procedurally generated...
        document.querySelector('meta[name="description"]').setAttribute("content", poemData.summary)
        document.querySelector('meta[name="keywords"]').setAttribute("content", poemData.tags)
    }
    
    initialise()
</script>
</html>
